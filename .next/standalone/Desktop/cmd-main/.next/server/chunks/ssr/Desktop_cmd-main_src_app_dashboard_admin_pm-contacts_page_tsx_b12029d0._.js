module.exports=[33739,a=>{"use strict";var b=a.i(43713),c=a.i(68599),d=a.i(84642),e=a.i(17545);let f=(0,a.i(90306).default)("calculator",[["rect",{width:"16",height:"20",x:"4",y:"2",rx:"2",key:"1nb95v"}],["line",{x1:"8",x2:"16",y1:"6",y2:"6",key:"x4nwl0"}],["line",{x1:"16",x2:"16",y1:"14",y2:"18",key:"wjye3r"}],["path",{d:"M16 10h.01",key:"1m94wz"}],["path",{d:"M12 10h.01",key:"1nrarc"}],["path",{d:"M8 10h.01",key:"19clt8"}],["path",{d:"M12 14h.01",key:"1etili"}],["path",{d:"M8 14h.01",key:"6423bh"}],["path",{d:"M12 18h.01",key:"mhygvu"}],["path",{d:"M8 18h.01",key:"lrp35t"}]]);var g=a.i(94171),h=a.i(27167),i=a.i(31572),j=a.i(49466),k=a.i(84194),l=a.i(63395),m=a.i(57684),n=a.i(59627),o=a.i(65189),p=a.i(84177),q=a.i(48421),r=a.i(61977),s=a.i(78538),t=a.i(73348);let u=["ADMIN","ACCOUNTANT","PROJECT_MANAGER"],v={ADMIN:{title:"أرقام الإدارة",description:"هذه الأرقام مخولة بطلب أي بيانات أو تعديل صلاحيات المستخدمين عبر التكامل."},ACCOUNTANT:{title:"أرقام المحاسبين",description:"تسمح بإرسال أوامر الاستعلام عن الفواتير، الدفعات، والملاحظات المحاسبية."},PROJECT_MANAGER:{title:"أرقام مديري المشاريع",description:"تُستخدم لإرسال المصروفات التشغيلية والملاحظات الخاصة بمشاريع محددة."}};function w(){let{data:a,status:w}=(0,d.useSession)(),x=(0,e.useRouter)(),{toast:y}=(0,k.useToast)(),[z,A]=(0,c.useState)({ADMIN:[],ACCOUNTANT:[],PROJECT_MANAGER:[]}),[B,C]=(0,c.useState)([]),[D,E]=(0,c.useState)({}),[F,G]=(0,c.useState)(!0),[H,I]=(0,c.useState)(null),[J,K]=(0,c.useState)(null),[L,M]=(0,c.useState)([]),[N,O]=(0,c.useState)(!1),[P,Q]=(0,c.useState)(null),R=a?.user?.role==="ADMIN";(0,c.useEffect)(()=>{"loading"===w||(a&&R?(async()=>{try{G(!0),Q(null);let[a,b]=await Promise.all([Promise.all(u.map(a=>fetch(`/api/users?role=${a}`,{cache:"no-store"}))),fetch("/api/projects",{cache:"no-store"})]);if(a.find(a=>!a.ok))throw Error("تعذر تحميل بيانات المستخدمين");if(!b.ok)throw Error("تعذر تحميل قائمة المشاريع");let c=await Promise.all(a.map(a=>a.json())),d=await b.json(),e={ADMIN:[],ACCOUNTANT:[],PROJECT_MANAGER:[]};u.forEach((a,b)=>{let d=c[b];e[a]=Array.isArray(d)?d:[]}),A(e),C(Array.isArray(d)?d:[]);let f={};u.forEach(a=>{e[a].forEach(a=>{f[a.id]=a.whatsappPhone??""})}),E(f)}catch(a){console.error("Error loading contact data:",a),Q(a instanceof Error?a.message:"تعذر تحميل البيانات"),y({title:"خطأ",description:a instanceof Error?a.message:"يرجى المحاولة مرة أخرى",variant:"destructive"})}finally{G(!1)}})():x.replace("/dashboard"))},[a,w,R,x,y]);let S=()=>{K(null),M([])},T=async a=>{let b=D[a.id]?.trim()??"";try{I(a.id);let c=await fetch(`/api/users/${a.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({whatsappPhone:b||null})});if(!c.ok){let a=await c.json().catch(()=>null),b=a?.error||"تعذر حفظ الرقم";throw Error(b)}let d=await c.json(),e=d.role;u.includes(e)&&A(a=>({...a,[e]:a[e].map(a=>a.id===d.id?d:a)})),E(a=>({...a,[d.id]:d.whatsappPhone??""})),y({title:"تم الحفظ",description:"تم تحديث رقم واتساب بنجاح"})}catch(a){console.error("Error saving contact phone:",a),y({title:"خطأ",description:a instanceof Error?a.message:"تعذر حفظ الرقم",variant:"destructive"})}finally{I(null)}},U=async()=>{if(J)try{O(!0);let a=await fetch(`/api/users/${J.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({projectIds:L})});if(!a.ok){let b=await a.json().catch(()=>null),c=b?.error||"تعذر تحديث المشاريع";throw Error(c)}let b=await a.json(),c=b.role;u.includes(c)&&A(a=>({...a,[c]:a[c].map(a=>a.id===b.id?b:a)})),S(),y({title:"تم الحفظ",description:"تم تحديث المشاريع المسندة"})}catch(a){console.error("Error saving manager projects:",a),y({title:"خطأ",description:a instanceof Error?a.message:"تعذر تحديث المشاريع",variant:"destructive"})}finally{O(!1)}},V=(0,c.useMemo)(()=>z.PROJECT_MANAGER.reduce((a,b)=>a+(b.assignedProjects?.length??0),0),[z.PROJECT_MANAGER]),W=z.ADMIN,X=z.ACCOUNTANT,Y=z.PROJECT_MANAGER,Z=W.filter(a=>a.whatsappPhone&&a.whatsappPhone.length>0).length,$=X.filter(a=>a.whatsappPhone&&a.whatsappPhone.length>0).length,_=Y.filter(a=>a.whatsappPhone&&a.whatsappPhone.length>0).length;return"loading"===w||a&&!R?(0,b.jsx)("div",{className:"flex items-center justify-center h-full",children:(0,b.jsx)(g.Loader2,{className:"h-6 w-6 animate-spin text-muted-foreground"})}):(0,b.jsx)("div",{className:"flex-1 p-8 lg:p-12",children:(0,b.jsxs)("div",{className:"max-w-6xl mx-auto space-y-6",children:[(0,b.jsxs)("div",{className:"flex flex-col gap-2",children:[(0,b.jsx)("h1",{className:"text-3xl font-semibold text-gray-900",children:"أرقام WhatsApp المصرح بها"}),(0,b.jsx)("p",{className:"text-gray-500",children:"حدّث الأرقام التي يعتمد عليها تكامل n8n للسماح بالطلبات الواردة من الإدارة، المحاسبين، ومديري المشاريع."})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-4",children:[(0,b.jsxs)(m.Card,{className:"border-[#E5E7EB]",children:[(0,b.jsxs)(m.CardHeader,{className:"pb-2",children:[(0,b.jsxs)(m.CardTitle,{className:"text-sm font-medium flex items-center gap-2",children:[(0,b.jsx)(i.ShieldCheck,{className:"h-4 w-4 text-emerald-600"}),"أرقام الإدارة المسجلة"]}),(0,b.jsx)(m.CardDescription,{children:"عدد حسابات الإدارة التي تمتلك رقم واتساب صالح"})]}),(0,b.jsx)(m.CardContent,{children:(0,b.jsx)("div",{className:"text-2xl font-bold",children:Z})})]}),(0,b.jsxs)(m.Card,{className:"border-[#E5E7EB]",children:[(0,b.jsxs)(m.CardHeader,{className:"pb-2",children:[(0,b.jsxs)(m.CardTitle,{className:"text-sm font-medium flex items-center gap-2",children:[(0,b.jsx)(f,{className:"h-4 w-4 text-emerald-600"}),"أرقام المحاسبين المسجلة"]}),(0,b.jsx)(m.CardDescription,{children:"المحاسبون القادرون على تنفيذ أوامر الاستعلام المالي"})]}),(0,b.jsx)(m.CardContent,{children:(0,b.jsx)("div",{className:"text-2xl font-bold",children:$})})]}),(0,b.jsxs)(m.Card,{className:"border-[#E5E7EB]",children:[(0,b.jsxs)(m.CardHeader,{className:"pb-2",children:[(0,b.jsxs)(m.CardTitle,{className:"text-sm font-medium flex items-center gap-2",children:[(0,b.jsx)(j.Users,{className:"h-4 w-4 text-emerald-600"}),"مدراء مشاريع برقم مسجل"]}),(0,b.jsxs)(m.CardDescription,{children:[_," من أصل ",Y.length," لديهم رقم فعّال"]})]}),(0,b.jsx)(m.CardContent,{children:(0,b.jsx)("div",{className:"text-2xl font-bold",children:_})})]}),(0,b.jsxs)(m.Card,{className:"border-[#E5E7EB]",children:[(0,b.jsxs)(m.CardHeader,{className:"pb-2",children:[(0,b.jsxs)(m.CardTitle,{className:"text-sm font-medium flex items-center gap-2",children:[(0,b.jsx)(h.Phone,{className:"h-4 w-4 text-emerald-600"}),"إجمالي الإسنادات"]}),(0,b.jsx)(m.CardDescription,{children:"عدد المشاريع المرتبطة بمديري المشاريع المصرح بهم"})]}),(0,b.jsx)(m.CardContent,{children:(0,b.jsx)("div",{className:"text-2xl font-bold",children:V})})]})]}),(0,b.jsxs)(m.Card,{className:"border-[#E5E7EB]",children:[(0,b.jsxs)(m.CardHeader,{children:[(0,b.jsx)(m.CardTitle,{className:"text-lg font-semibold",children:"إدارة جهات الاتصال المصرح بها"}),(0,b.jsx)(m.CardDescription,{children:"يمكن للمسؤول فقط تعديل الأرقام لضمان أن التكامل يقبل الرسائل من المستخدمين المخولين فقط."})]}),(0,b.jsx)(m.CardContent,{children:F?(0,b.jsx)("div",{className:"space-y-3",children:[1,2,3].map(a=>(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-4 gap-4 items-center",children:[(0,b.jsx)(p.Skeleton,{className:"h-10"}),(0,b.jsx)(p.Skeleton,{className:"h-10"}),(0,b.jsx)(p.Skeleton,{className:"h-10"}),(0,b.jsx)(p.Skeleton,{className:"h-10"})]},a))}):P?(0,b.jsx)("div",{className:"rounded-lg border border-red-200 bg-red-50 p-4 text-red-700 text-sm",children:P}):(0,b.jsx)("div",{className:"space-y-10",children:u.map(a=>{let c,d;return(0,b.jsx)("div",{children:(c=z[a],d=v[a],"PROJECT_MANAGER"===a?(0,b.jsxs)("section",{className:"space-y-4",children:[(0,b.jsxs)("header",{children:[(0,b.jsx)("h3",{className:"text-base font-semibold text-gray-900",children:d.title}),(0,b.jsx)("p",{className:"text-sm text-gray-500",children:d.description})]}),0===c.length?(0,b.jsx)("p",{className:"text-sm text-gray-400",children:"لا يوجد مديرو مشاريع حتى الآن."}):(0,b.jsx)("div",{className:"space-y-4",children:c.map(a=>{let c=a.assignedProjects?.map(a=>a.project.name)??[];return(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-[1.5fr_1fr_1fr_auto] gap-3 md:items-center border border-gray-100 rounded-lg p-4",children:[(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("p",{className:"font-medium text-gray-900",children:a.name}),(0,b.jsx)("p",{className:"text-xs text-gray-500",children:a.email})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)(r.Label,{className:"text-xs text-gray-500",children:"رقم واتساب"}),(0,b.jsx)(n.Input,{value:D[a.id]??"",onChange:b=>E(c=>({...c,[a.id]:b.target.value})),placeholder:"أدخل الرقم بصيغة دولية"})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(r.Label,{className:"text-xs text-gray-500",children:"المشاريع المسندة"}),0===c.length?(0,b.jsx)("p",{className:"text-xs text-gray-400",children:"لم يتم تحديد مشاريع بعد"}):(0,b.jsx)("div",{className:"flex flex-wrap gap-2",children:c.map(a=>(0,b.jsx)(o.Badge,{variant:"secondary",className:"text-xs",children:a},a))}),(0,b.jsxs)(q.Dialog,{open:J?.id===a.id,onOpenChange:b=>b?void(K(a),M(a.assignedProjects?.map(a=>a.projectId)??[])):S(),children:[(0,b.jsx)(q.DialogTrigger,{asChild:!0,children:(0,b.jsx)(l.Button,{variant:"outline",size:"sm",children:"إدارة المشاريع"})}),(0,b.jsxs)(q.DialogContent,{className:"max-w-lg",children:[(0,b.jsxs)(q.DialogHeader,{children:[(0,b.jsx)(q.DialogTitle,{children:"المشاريع المسندة"}),(0,b.jsx)(q.DialogDescription,{children:"اختر المشاريع التي يمكن لهذا المدير إدارتها."})]}),(0,b.jsx)(t.ScrollArea,{className:"max-h-72 pr-4",children:(0,b.jsx)("div",{className:"space-y-2",children:B.map(a=>{let c=L.includes(a.id);return(0,b.jsxs)("label",{className:"flex items-center justify-between gap-3 rounded-md border border-gray-100 px-3 py-2 text-sm hover:bg-gray-50",children:[(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[(0,b.jsx)(s.Checkbox,{checked:c,onCheckedChange:b=>{var c,d;return c=a.id,d=!!b,void M(a=>d?Array.from(new Set([...a,c])):a.filter(a=>a!==c))}}),(0,b.jsx)("span",{children:a.name})]}),c&&(0,b.jsx)(o.Badge,{variant:"outline",className:"text-xs",children:"مختار"})]},a.id)})})}),(0,b.jsxs)(q.DialogFooter,{children:[(0,b.jsx)(l.Button,{variant:"outline",onClick:S,children:"إلغاء"}),(0,b.jsxs)(l.Button,{onClick:U,disabled:N,children:[N&&(0,b.jsx)(g.Loader2,{className:"mr-2 h-4 w-4 animate-spin"}),"حفظ المشاريع"]})]})]})]})]}),(0,b.jsxs)("div",{className:"flex flex-col gap-2 md:items-end",children:[(0,b.jsxs)(l.Button,{onClick:()=>void T(a),disabled:H===a.id,children:[H===a.id&&(0,b.jsx)(g.Loader2,{className:"mr-2 h-4 w-4 animate-spin"}),"حفظ الرقم"]}),(0,b.jsx)("p",{className:"text-[11px] text-gray-400",children:a.whatsappPhone?"سيتم اعتماد الرقم بعد الحفظ":"لم يتم تسجيل رقم بعد"})]})]},a.id)})})]},a):(0,b.jsxs)("section",{className:"space-y-4",children:[(0,b.jsxs)("header",{children:[(0,b.jsx)("h3",{className:"text-base font-semibold text-gray-900",children:d.title}),(0,b.jsx)("p",{className:"text-sm text-gray-500",children:d.description})]}),0===c.length?(0,b.jsx)("p",{className:"text-sm text-gray-400",children:"لا يوجد مستخدمون بهذا الدور حتى الآن."}):(0,b.jsx)("div",{className:"space-y-4",children:c.map(a=>(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-[1.5fr_1fr_auto] gap-3 md:items-center border border-gray-100 rounded-lg p-4",children:[(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("p",{className:"font-medium text-gray-900",children:a.name}),(0,b.jsx)("p",{className:"text-xs text-gray-500",children:a.email})]}),(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)(r.Label,{className:"text-xs text-gray-500",children:"رقم واتساب"}),(0,b.jsx)(n.Input,{value:D[a.id]??"",onChange:b=>E(c=>({...c,[a.id]:b.target.value})),placeholder:"أدخل الرقم بصيغة دولية"})]}),(0,b.jsxs)("div",{className:"flex flex-col gap-2 md:items-end",children:[(0,b.jsxs)(l.Button,{onClick:()=>void T(a),disabled:H===a.id,children:[H===a.id&&(0,b.jsx)(g.Loader2,{className:"mr-2 h-4 w-4 animate-spin"}),"حفظ الرقم"]}),(0,b.jsx)("p",{className:"text-[11px] text-gray-400",children:a.whatsappPhone?"سيتم اعتماد الرقم بعد الحفظ":"لم يتم تسجيل رقم بعد"})]})]},a.id))})]},a))},a)})})})]})]})})}a.s(["default",()=>w],33739)}];

//# sourceMappingURL=Desktop_cmd-main_src_app_dashboard_admin_pm-contacts_page_tsx_b12029d0._.js.map