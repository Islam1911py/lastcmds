module.exports=[40530,a=>{"use strict";var b=a.i(43713),c=a.i(68599),d=a.i(84642),e=a.i(17545),f=a.i(90306);let g=(0,f.default)("arrow-left",[["path",{d:"m12 19-7-7 7-7",key:"1l729n"}],["path",{d:"M19 12H5",key:"x3x0zl"}]]);var h=a.i(49015),i=a.i(55658),j=a.i(91564),k=a.i(15877),l=a.i(79059),m=a.i(72760);let n=(0,f.default)("download",[["path",{d:"M12 15V3",key:"m9g1x1"}],["path",{d:"M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4",key:"ih7n3h"}],["path",{d:"m7 10 5 5 5-5",key:"brsn70"}]]);var o=a.i(8569),p=a.i(9446),q=a.i(27167),r=a.i(53749),s=a.i(57684),t=a.i(63395),u=a.i(66128),v=a.i(65189),w=a.i(59627),x=a.i(61977),y=a.i(77726),z=a.i(26968),A=a.i(48421),B=a.i(84194);function C(){let a=(0,e.useParams)(),f=(0,e.useRouter)(),{data:C,status:D}=(0,d.useSession)(),{toast:E}=(0,B.useToast)(),F=a.id,[G,H]=(0,c.useState)(null),[I,J]=(0,c.useState)(!0),[K,L]=(0,c.useState)(null),[M,N]=(0,c.useState)(!1),[O,P]=(0,c.useState)(!1),[Q,R]=(0,c.useState)(""),[S,T]=(0,c.useState)(!1);(0,c.useEffect)(()=>{if("unauthenticated"===D)return void f.push("/login");if("loading"!==D&&C){if("ADMIN"!==C.user.role&&"ACCOUNTANT"!==C.user.role)return void f.replace("/dashboard");U()}},[C,D,F]);let U=async()=>{try{J(!0),L(null);let a=await fetch(`/api/invoices/${F}`);if(404===a.status)return void L("Invoice not found");if(!a.ok)throw Error("Failed to fetch invoice");let b=await a.json();H(b)}catch(a){console.error("Error:",a),L("An error occurred while fetching the invoice")}finally{J(!1)}},V=async()=>{if(!G)return;let a=Number(Q);if(!Number.isFinite(a)||a<=0)return void E({title:"قيمة غير صالحة",description:"يرجى إدخال مبلغ صحيح للدفع",variant:"destructive"});if(a>G.remainingBalance+.001)return void E({title:"مبلغ أكبر من المستحق",description:"لا يمكن دفع مبلغ يتجاوز المتبقي على الفاتورة",variant:"destructive"});try{T(!0);let b=await fetch(`/api/invoices/${G.id}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"pay",amount:a})});if(!b.ok){let a=await b.json().catch(()=>null);throw Error(a?.error||"فشل في معالجة الدفع")}let c=await b.json();H(c),P(!1),R(""),E({title:"تم الدفع",description:"تم تسجيل عملية الدفع بنجاح."})}catch(a){console.error("Payment error:",a),E({title:"فشل الدفع",description:a instanceof Error?a.message:"حدث خطأ أثناء الدفع",variant:"destructive"})}finally{T(!1)}};if(I)return(0,b.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,b.jsx)(l.Loader,{className:"h-8 w-8 animate-spin"})});if(K||!G)return(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)(t.Button,{variant:"outline",size:"sm",onClick:()=>f.back(),className:"gap-2",children:[(0,b.jsx)(g,{className:"h-4 w-4"}),"رجوع"]}),(0,b.jsxs)(u.Alert,{variant:"destructive",children:[(0,b.jsx)(m.AlertCircle,{className:"h-4 w-4"}),(0,b.jsx)(u.AlertDescription,{children:K||"الفاتورة غير موجودة"})]})]});let W=async()=>{if(G)try{N(!0);let a=await fetch(`/api/invoices/${G.id}/pdf`);if(!a.ok)throw Error("Failed to generate PDF");let b=await a.blob(),c=URL.createObjectURL(b),d=a=>a.replace(/[\\/:*?"<>|]+/g,"-").replace(/\s+/g," ").trim(),e=`${d(G.unit.project.name)}-${d(G.unit.name)}-${d(G.invoiceNumber)}.pdf`,f=document.createElement("a");f.href=c,f.download=e,document.body.appendChild(f),f.click(),f.remove(),URL.revokeObjectURL(c)}catch(a){console.error("Error generating PDF:",a),alert("حدث خطأ أثناء إنشاء ملف PDF")}finally{N(!1)}},X="MANAGEMENT_SERVICE"===G.type?"فاتورة خدمات":"فاتورة مطالبة",Y=G.ownerAssociation?.contacts??[],Z=Y.find(a=>"PHONE"===a.type&&a.isPrimary)?.value,$=Y.find(a=>"EMAIL"===a.type&&a.isPrimary)?.value,_=Y.filter(a=>!a.isPrimary);return(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{"data-print-hide":"true",className:"flex flex-wrap items-center justify-between gap-2",children:[(0,b.jsxs)("div",{className:"flex flex-wrap items-center gap-2",children:[(0,b.jsxs)(t.Button,{variant:"outline",size:"sm",onClick:()=>f.back(),className:"gap-2",children:[(0,b.jsx)(g,{className:"h-4 w-4"}),"رجوع"]}),(0,b.jsx)(t.Button,{variant:"outline",size:"sm",onClick:W,className:"gap-2",disabled:M,children:M?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(l.Loader,{className:"h-4 w-4 animate-spin"}),"جاري التحميل..."]}):(0,b.jsxs)(b.Fragment,{children:[(0,b.jsx)(n,{className:"h-4 w-4"}),"تحميل PDF"]})}),(0,b.jsxs)(t.Button,{variant:"outline",size:"sm",onClick:()=>window.print(),className:"gap-2",children:[(0,b.jsx)(o.Printer,{className:"h-4 w-4"}),"طباعة"]})]}),!G.isPaid&&(0,b.jsxs)(t.Button,{size:"sm",className:"gap-2 bg-green-600 hover:bg-green-700",onClick:()=>{G&&(R(G.remainingBalance.toFixed(2)),P(!0))},children:[(0,b.jsx)(p.CreditCard,{className:"h-4 w-4"}),"دفع الفاتورة"]})]}),(0,b.jsxs)("div",{"data-print-root":"true",className:"space-y-6 bg-white border border-gray-200 rounded-xl p-6 md:p-8 max-w-[900px] mx-auto",dir:"rtl",children:[(0,b.jsxs)("div",{className:"flex flex-wrap items-center justify-between gap-4 border-b border-gray-200 pb-4",children:[(0,b.jsxs)("div",{className:"flex items-center gap-3",children:[(0,b.jsx)("img",{src:"/logo.svg",alt:"CMDS",className:"h-12 w-12 rounded-lg border border-gray-200 bg-white"}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-xs text-gray-500",children:"الجهة المُصدِرة"}),(0,b.jsx)("p",{className:"text-lg font-semibold text-gray-900",children:"CMDS"})]})]}),(0,b.jsx)("div",{className:"text-sm text-gray-500",children:X})]}),(0,b.jsxs)("div",{className:"flex items-start justify-between gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsxs)("h1",{className:"text-3xl font-semibold text-gray-900",children:["فاتورة رقم ",G.invoiceNumber]}),(0,b.jsx)("p",{className:"text-gray-500 mt-2",children:X.replace("فاتورة ","")})]}),(0,b.jsx)(v.Badge,{className:G.isPaid?"bg-[#ECFDF5] border border-[#16A34A]/20 text-[#16A34A]":"bg-[#FEF2F2] border border-[#DC2626]/20 text-[#DC2626]",children:G.isPaid?"مدفوعة":"غير مدفوعة"})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,b.jsxs)(s.Card,{children:[(0,b.jsx)(s.CardHeader,{className:"pb-2",children:(0,b.jsxs)(s.CardTitle,{className:"text-sm font-medium flex items-center gap-2",children:[(0,b.jsx)(h.DollarSign,{className:"h-4 w-4 text-gray-500"}),"إجمالي الفاتورة"]})}),(0,b.jsx)(s.CardContent,{children:(0,b.jsxs)("div",{className:"text-2xl font-semibold text-gray-900",children:[G.amount.toFixed(2)," ج.م"]})})]}),(0,b.jsxs)(s.Card,{children:[(0,b.jsx)(s.CardHeader,{className:"pb-2",children:(0,b.jsxs)(s.CardTitle,{className:"text-sm font-medium flex items-center gap-2",children:[(0,b.jsx)(h.DollarSign,{className:"h-4 w-4 text-gray-500"}),"إجمالي المدفوع"]})}),(0,b.jsx)(s.CardContent,{children:(0,b.jsxs)("div",{className:"text-2xl font-semibold text-gray-900",children:[G.totalPaid.toFixed(2)," ج.م"]})})]}),(0,b.jsxs)(s.Card,{children:[(0,b.jsx)(s.CardHeader,{className:"pb-2",children:(0,b.jsxs)(s.CardTitle,{className:"text-sm font-medium flex items-center gap-2",children:[(0,b.jsx)(h.DollarSign,{className:"h-4 w-4 text-gray-500"}),"المتبقي"]})}),(0,b.jsx)(s.CardContent,{children:(0,b.jsxs)("div",{className:"text-2xl font-semibold text-gray-900",children:[G.remainingBalance.toFixed(2)," ج.م"]})})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[(0,b.jsxs)(s.Card,{children:[(0,b.jsx)(s.CardHeader,{children:(0,b.jsxs)(s.CardTitle,{className:"text-base flex items-center gap-2",children:[(0,b.jsx)(k.MapPin,{className:"h-4 w-4 text-gray-500"}),"بيانات المشروع"]})}),(0,b.jsxs)(s.CardContent,{className:"space-y-3",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-sm text-gray-500",children:"المشروع"}),(0,b.jsx)("p",{className:"font-medium text-gray-900",children:G.unit.project.name})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-sm text-gray-500",children:"الوحدة"}),(0,b.jsx)("p",{className:"font-medium text-gray-900",children:G.unit.name}),(0,b.jsxs)("p",{className:"text-xs text-gray-500",children:["الكود: ",G.unit.code]})]})]})]}),(0,b.jsxs)(s.Card,{children:[(0,b.jsx)(s.CardHeader,{children:(0,b.jsxs)(s.CardTitle,{className:"text-base flex items-center gap-2",children:[(0,b.jsx)(j.User,{className:"h-4 w-4 text-gray-500"}),"بيانات المالك"]})}),(0,b.jsx)(s.CardContent,{className:"space-y-3",children:G.ownerAssociation?(0,b.jsxs)(b.Fragment,{children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-sm text-gray-500",children:"الاسم"}),(0,b.jsx)("p",{className:"font-medium text-gray-900",children:G.ownerAssociation.name})]}),($||G.ownerAssociation.email)&&(0,b.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-900",children:[(0,b.jsx)(r.Mail,{className:"h-4 w-4 text-gray-500"}),(0,b.jsx)("span",{children:$||G.ownerAssociation.email})]}),(Z||G.ownerAssociation.phone)&&(0,b.jsxs)("div",{className:"flex items-center gap-2 text-sm text-gray-900",children:[(0,b.jsx)(q.Phone,{className:"h-4 w-4 text-gray-500"}),(0,b.jsx)("span",{children:Z||G.ownerAssociation.phone})]}),_.length>0&&(0,b.jsxs)("div",{className:"space-y-2 pt-2 border-t",children:[(0,b.jsx)("p",{className:"text-sm text-gray-500",children:"جهات اتصال إضافية"}),(0,b.jsx)("div",{className:"space-y-1",children:_.map(a=>(0,b.jsxs)("div",{className:"flex items-center justify-between text-sm",children:[(0,b.jsxs)("div",{className:"flex items-center gap-2 text-gray-900",children:["PHONE"===a.type?(0,b.jsx)(q.Phone,{className:"h-4 w-4 text-gray-500"}):(0,b.jsx)(r.Mail,{className:"h-4 w-4 text-gray-500"}),(0,b.jsx)("span",{children:a.value})]}),a.label&&(0,b.jsx)("span",{className:"text-xs text-gray-500",children:a.label})]},a.id))})]})]}):(0,b.jsx)("p",{className:"text-sm text-gray-500",children:"لا توجد بيانات لجهة المالك المرتبطة بهذه الوحدة."})})]})]}),(0,b.jsxs)(s.Card,{children:[(0,b.jsx)(s.CardHeader,{children:(0,b.jsxs)(s.CardTitle,{className:"text-base flex items-center gap-2",children:[(0,b.jsx)(i.Calendar,{className:"h-4 w-4 text-gray-500"}),"تاريخ الإصدار"]})}),(0,b.jsx)(s.CardContent,{children:(0,b.jsx)("p",{className:"font-medium text-gray-900",children:(0,z.format)(new Date(G.issuedAt),"dd MMMM yyyy")})})]}),G.expenses&&G.expenses.length>0&&(0,b.jsxs)(s.Card,{children:[(0,b.jsxs)(s.CardHeader,{children:[(0,b.jsx)(s.CardTitle,{className:"text-base",children:"تفاصيل المصاريف"}),(0,b.jsx)("p",{className:"text-sm text-gray-500 mt-1",children:"تاريخ ووصف ومبلغ كل عنصر"})]}),(0,b.jsx)(s.CardContent,{children:(0,b.jsx)("div",{className:"overflow-x-auto",children:(0,b.jsxs)(y.Table,{children:[(0,b.jsx)(y.TableHeader,{children:(0,b.jsxs)(y.TableRow,{children:[(0,b.jsx)(y.TableHead,{children:"التاريخ"}),(0,b.jsx)(y.TableHead,{children:"الوصف"}),(0,b.jsx)(y.TableHead,{children:"المصدر"}),(0,b.jsx)(y.TableHead,{className:"text-right",children:"المبلغ"})]})}),(0,b.jsxs)(y.TableBody,{children:[G.expenses.map(a=>(0,b.jsxs)(y.TableRow,{children:[(0,b.jsx)(y.TableCell,{className:"text-sm",children:a.date?(0,z.format)(new Date(a.date),"dd MMM yyyy"):"-"}),(0,b.jsx)(y.TableCell,{className:"font-medium text-gray-900",children:a.description}),(0,b.jsx)(y.TableCell,{className:"text-sm text-gray-500",children:a.sourceType||"-"}),(0,b.jsxs)(y.TableCell,{className:"text-right font-semibold text-gray-900",children:[a.amount.toLocaleString()," ج.م"]})]},a.id)),(0,b.jsxs)(y.TableRow,{className:"bg-[#F9FAFB] font-semibold",children:[(0,b.jsx)(y.TableCell,{colSpan:3,className:"text-right",children:"الإجمالي:"}),(0,b.jsxs)(y.TableCell,{className:"text-right text-gray-900",children:[G.expenses.reduce((a,b)=>a+b.amount,0).toLocaleString()," ج.م"]})]})]})]})})})]}),G.payments&&G.payments.length>0&&(0,b.jsxs)(s.Card,{children:[(0,b.jsx)(s.CardHeader,{children:(0,b.jsx)(s.CardTitle,{className:"text-base",children:"سجل المدفوعات"})}),(0,b.jsx)(s.CardContent,{children:(0,b.jsx)("div",{className:"overflow-x-auto",children:(0,b.jsxs)(y.Table,{children:[(0,b.jsx)(y.TableHeader,{children:(0,b.jsxs)(y.TableRow,{children:[(0,b.jsx)(y.TableHead,{children:"رقم العملية"}),(0,b.jsx)(y.TableHead,{children:"المبلغ"}),(0,b.jsx)(y.TableHead,{children:"التاريخ"})]})}),(0,b.jsx)(y.TableBody,{children:G.payments.map(a=>(0,b.jsxs)(y.TableRow,{children:[(0,b.jsxs)(y.TableCell,{className:"font-mono text-sm",children:[a.id.slice(0,8),"..."]}),(0,b.jsxs)(y.TableCell,{className:"font-medium text-gray-900",children:[a.amount.toFixed(2)," ج.م"]}),(0,b.jsx)(y.TableCell,{children:a.createdAt?(0,z.format)(new Date(a.createdAt),"dd MMM yyyy"):"غير متاح"})]},a.id))})]})})})]})]}),(0,b.jsx)(A.Dialog,{open:O,onOpenChange:a=>{P(a),a||(R(""),T(!1))},children:(0,b.jsxs)(A.DialogContent,{className:"sm:max-w-md",children:[(0,b.jsxs)(A.DialogHeader,{children:[(0,b.jsx)(A.DialogTitle,{children:"دفع الفاتورة"}),(0,b.jsx)(A.DialogDescription,{children:"يمكنك دفع جزء من المبلغ المستحق أو سداده بالكامل."})]}),(0,b.jsxs)("div",{className:"space-y-4 py-2",children:[(0,b.jsxs)("div",{className:"rounded-lg bg-gray-50 p-4",children:[(0,b.jsx)("p",{className:"text-sm text-gray-600",children:"المتبقي على الفاتورة"}),(0,b.jsxs)("p",{className:"text-2xl font-semibold text-gray-900",children:[G.remainingBalance.toFixed(2)," ج.م"]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(x.Label,{htmlFor:"payment-amount",children:"مبلغ الدفع (ج.م)"}),(0,b.jsx)(w.Input,{id:"payment-amount",type:"number",step:"0.01",min:0,max:G.remainingBalance,value:Q,onChange:a=>R(a.target.value),disabled:S,placeholder:`المتاح حتى ${G.remainingBalance.toFixed(2)} ج.م`}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground",children:"يمكنك إدخال مبلغ جزئي أو الضغط على زر الدفع الكامل أدناه."})]}),(0,b.jsx)("div",{className:"flex gap-2",children:(0,b.jsx)(t.Button,{variant:"outline",className:"flex-1",onClick:()=>R(G.remainingBalance.toFixed(2)),disabled:S,children:"دفع كامل المبلغ"})})]}),(0,b.jsxs)(A.DialogFooter,{className:"gap-2",children:[(0,b.jsx)(t.Button,{variant:"outline",onClick:()=>P(!1),disabled:S,children:"إلغاء"}),(0,b.jsx)(t.Button,{onClick:V,disabled:S||!Q,className:"bg-green-600 hover:bg-green-700",children:S?"جاري المعالجة...":"تأكيد الدفع"})]})]})}),(0,b.jsx)("div",{"data-print-hide":"true",children:(0,b.jsxs)(s.Card,{children:[(0,b.jsx)(s.CardHeader,{children:(0,b.jsx)(s.CardTitle,{className:"text-base",children:"التنقل السريع"})}),(0,b.jsx)(s.CardContent,{children:(0,b.jsxs)("div",{className:"flex flex-wrap gap-2",children:[(0,b.jsx)("button",{onClick:()=>f.push(`/dashboard/operational-units/${G.unit.id}`),className:"text-sm px-3 py-2 bg-[#F3F4F6] hover:bg-[#E5E7EB] text-[#111827] border border-[#E5E7EB] rounded-md font-medium transition-colors",children:"تفاصيل الوحدة"}),(0,b.jsx)("button",{onClick:()=>f.push(`/dashboard/payments?unit=${G.unit.id}`),className:"text-sm px-3 py-2 bg-[#F3F4F6] hover:bg-[#E5E7EB] text-[#111827] border border-[#E5E7EB] rounded-md font-medium transition-colors",children:"مدفوعات الوحدة"}),(0,b.jsx)("button",{onClick:()=>f.push("/dashboard/invoices"),className:"text-sm px-3 py-2 bg-[#F3F4F6] hover:bg-[#E5E7EB] text-[#111827] border border-[#E5E7EB] rounded-md font-medium transition-colors",children:"الرجوع للفواتير"})]})})]})})]})}a.s(["default",()=>C],40530)}];

//# sourceMappingURL=Desktop_cmd-main_src_app_dashboard_invoices_%5Bid%5D_page_tsx_1c735fa3._.js.map