module.exports = [
"[externals]/next/dist/compiled/next-server/app-route-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-route-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-route-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/@opentelemetry/api [external] (next/dist/compiled/@opentelemetry/api, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/@opentelemetry/api", () => require("next/dist/compiled/@opentelemetry/api"));

module.exports = mod;
}),
"[externals]/next/dist/compiled/next-server/app-page-turbo.runtime.dev.js [external] (next/dist/compiled/next-server/app-page-turbo.runtime.dev.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js", () => require("next/dist/compiled/next-server/app-page-turbo.runtime.dev.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-unit-async-storage.external.js [external] (next/dist/server/app-render/work-unit-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-unit-async-storage.external.js", () => require("next/dist/server/app-render/work-unit-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/work-async-storage.external.js [external] (next/dist/server/app-render/work-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/work-async-storage.external.js", () => require("next/dist/server/app-render/work-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/shared/lib/no-fallback-error.external.js [external] (next/dist/shared/lib/no-fallback-error.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/shared/lib/no-fallback-error.external.js", () => require("next/dist/shared/lib/no-fallback-error.external.js"));

module.exports = mod;
}),
"[externals]/next/dist/server/app-render/after-task-async-storage.external.js [external] (next/dist/server/app-render/after-task-async-storage.external.js, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("next/dist/server/app-render/after-task-async-storage.external.js", () => require("next/dist/server/app-render/after-task-async-storage.external.js"));

module.exports = mod;
}),
"[externals]/util [external] (util, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("util", () => require("util"));

module.exports = mod;
}),
"[externals]/url [external] (url, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("url", () => require("url"));

module.exports = mod;
}),
"[externals]/http [external] (http, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("http", () => require("http"));

module.exports = mod;
}),
"[externals]/crypto [external] (crypto, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("crypto", () => require("crypto"));

module.exports = mod;
}),
"[externals]/assert [external] (assert, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("assert", () => require("assert"));

module.exports = mod;
}),
"[externals]/querystring [external] (querystring, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("querystring", () => require("querystring"));

module.exports = mod;
}),
"[externals]/buffer [external] (buffer, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("buffer", () => require("buffer"));

module.exports = mod;
}),
"[externals]/zlib [external] (zlib, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("zlib", () => require("zlib"));

module.exports = mod;
}),
"[externals]/https [external] (https, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("https", () => require("https"));

module.exports = mod;
}),
"[externals]/events [external] (events, cjs)", ((__turbopack_context__, module, exports) => {

const mod = __turbopack_context__.x("events", () => require("events"));

module.exports = mod;
}),
"[project]/Desktop/cmd-main/src/lib/db.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "db",
    ()=>db
]);
var __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$2c$__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f40$prisma$2f$client$29$__ = __turbopack_context__.i("[externals]/@prisma/client [external] (@prisma/client, cjs, [project]/Desktop/cmd-main/node_modules/@prisma/client)");
;
const globalForPrisma = globalThis;
const db = globalForPrisma.prisma ?? new __TURBOPACK__imported__module__$5b$externals$5d2f40$prisma$2f$client__$5b$external$5d$__$2840$prisma$2f$client$2c$__cjs$2c$__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f40$prisma$2f$client$29$__["PrismaClient"]({
    log: [
        'query'
    ]
});
if ("TURBOPACK compile-time truthy", 1) globalForPrisma.prisma = db;
}),
"[project]/Desktop/cmd-main/src/lib/auth.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "authOptions",
    ()=>authOptions
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2d$auth$2f$providers$2f$credentials$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Desktop/cmd-main/node_modules/next-auth/providers/credentials.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Desktop/cmd-main/src/lib/db.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$bcryptjs$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Desktop/cmd-main/node_modules/bcryptjs/index.js [app-route] (ecmascript)");
;
;
;
const authOptions = {
    providers: [
        (0, __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2d$auth$2f$providers$2f$credentials$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"])({
            name: "credentials",
            credentials: {
                email: {
                    label: "Email",
                    type: "email"
                },
                password: {
                    label: "Password",
                    type: "password"
                }
            },
            async authorize (credentials) {
                if (!credentials?.email || !credentials?.password) {
                    throw new Error("Invalid credentials");
                }
                const user = await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].user.findUnique({
                    where: {
                        email: credentials.email
                    },
                    include: {
                        assignedProjects: {
                            include: {
                                project: true
                            }
                        }
                    }
                });
                if (!user) {
                    throw new Error("Invalid credentials");
                }
                const isPasswordValid = await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$bcryptjs$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["default"].compare(credentials.password, user.password);
                if (!isPasswordValid) {
                    throw new Error("Invalid credentials");
                }
                // Return user data for session
                return {
                    id: user.id,
                    email: user.email,
                    name: user.name,
                    role: user.role,
                    projectIds: user.assignedProjects.map((ap)=>ap.projectId),
                    canViewAllProjects: user.canViewAllProjects
                };
            }
        })
    ],
    callbacks: {
        async jwt ({ token, user }) {
            if (user) {
                token.id = user.id;
                token.role = user.role;
                token.projectIds = user.projectIds;
                token.canViewAllProjects = user.canViewAllProjects;
            }
            return token;
        },
        async session ({ session, token }) {
            if (session.user) {
                session.user.id = token.id;
                session.user.role = token.role;
                session.user.projectIds = token.projectIds;
                session.user.canViewAllProjects = token.canViewAllProjects;
            }
            return session;
        }
    },
    pages: {
        signIn: "/login",
        error: "/login"
    },
    session: {
        strategy: "jwt",
        maxAge: 30 * 24 * 60 * 60 // 30 days
    },
    secret: process.env.NEXTAUTH_SECRET
};
}),
"[project]/Desktop/cmd-main/src/app/api/accounting-notes/route.ts [app-route] (ecmascript)", ((__turbopack_context__) => {
"use strict";

__turbopack_context__.s([
    "GET",
    ()=>GET,
    "PATCH",
    ()=>PATCH,
    "POST",
    ()=>POST
]);
var __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Desktop/cmd-main/node_modules/next/server.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2d$auth$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Desktop/cmd-main/node_modules/next-auth/index.js [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$auth$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Desktop/cmd-main/src/lib/auth.ts [app-route] (ecmascript)");
var __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__ = __turbopack_context__.i("[project]/Desktop/cmd-main/src/lib/db.ts [app-route] (ecmascript)");
;
;
;
;
async function GET(req) {
    try {
        const session = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2d$auth$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getServerSession"])(__TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$auth$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["authOptions"]);
        if (!session) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Unauthorized"
            }, {
                status: 401
            });
        }
        const searchParams = req.nextUrl.searchParams;
        const status = searchParams.get("status");
        const projectId = searchParams.get("projectId");
        const filters = [];
        if (status) {
            filters.push({
                status
            });
        }
        if (projectId) {
            filters.push({
                projectId
            });
        }
        if (session.user.role === "PROJECT_MANAGER") {
            const assignedProjectIds = session.user.projectIds || [];
            if (!session.user.canViewAllProjects) {
                if (projectId && !assignedProjectIds.includes(projectId)) {
                    return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                        error: "Forbidden"
                    }, {
                        status: 403
                    });
                }
                if (assignedProjectIds.length === 0) {
                    return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json([]);
                }
                filters.push({
                    OR: [
                        {
                            createdByUserId: session.user.id
                        },
                        {
                            projectId: {
                                in: assignedProjectIds
                            }
                        }
                    ]
                });
            }
        } else if (session.user.role !== "ACCOUNTANT" && session.user.role !== "ADMIN") {
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Forbidden"
            }, {
                status: 403
            });
        }
        const where = filters.length > 0 ? {
            AND: filters
        } : undefined;
        // Fetch accounting notes with relations
        const notes = await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].accountingNote.findMany({
            where,
            include: {
                unit: {
                    include: {
                        project: true
                    }
                },
                project: true,
                createdByUser: {
                    select: {
                        id: true,
                        name: true,
                        email: true
                    }
                },
                convertedToExpense: {
                    include: {
                        recordedByUser: {
                            select: {
                                id: true,
                                name: true,
                                email: true
                            }
                        }
                    }
                },
                pmAdvance: {
                    include: {
                        staff: {
                            select: {
                                id: true,
                                name: true
                            }
                        }
                    }
                }
            },
            orderBy: {
                createdAt: "desc"
            }
        });
        return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json(notes);
    } catch (error) {
        console.error("Error fetching accounting notes:", error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "Failed to fetch accounting notes"
        }, {
            status: 500
        });
    }
}
async function POST(req) {
    try {
        const session = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2d$auth$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getServerSession"])(__TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$auth$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["authOptions"]);
        if (!session) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Unauthorized"
            }, {
                status: 401
            });
        }
        // Only Project Managers and Admin can create accounting notes
        if (session.user.role !== "PROJECT_MANAGER" && session.user.role !== "ADMIN") {
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Forbidden"
            }, {
                status: 403
            });
        }
        const body = await req.json();
        const { projectId, unitId, description, amount, sourceType = "OFFICE_FUND", pmAdvanceId } = body;
        const normalizedDescription = typeof description === "string" ? description.trim() : "";
        const parsedAmount = Number(amount);
        // Validate required fields
        if (!projectId || !unitId || !normalizedDescription || parsedAmount <= 0 || Number.isNaN(parsedAmount)) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Missing required fields"
            }, {
                status: 400
            });
        }
        if (sourceType !== "OFFICE_FUND" && sourceType !== "PM_ADVANCE") {
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Invalid source type. Must be OFFICE_FUND or PM_ADVANCE"
            }, {
                status: 400
            });
        }
        if (sourceType === "PM_ADVANCE" && !pmAdvanceId) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "pmAdvanceId is required when sourceType is PM_ADVANCE"
            }, {
                status: 400
            });
        }
        // Get operational unit to validate it belongs to project
        const unit = await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].operationalUnit.findUnique({
            where: {
                id: unitId
            },
            include: {
                project: true
            }
        });
        if (!unit) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Operational unit not found"
            }, {
                status: 404
            });
        }
        if (unit.projectId !== projectId) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Unit does not belong to the specified project"
            }, {
                status: 400
            });
        }
        // Check if PM is assigned to this project (if PROJECT_MANAGER role)
        if (session.user.role === "PROJECT_MANAGER") {
            const assignment = await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].projectAssignment.findFirst({
                where: {
                    userId: session.user.id,
                    projectId: projectId
                }
            });
            if (!assignment) {
                return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: "You are not assigned to this project"
                }, {
                    status: 403
                });
            }
        }
        if (sourceType === "PM_ADVANCE" && pmAdvanceId) {
            const advance = await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].pMAdvance.findUnique({
                where: {
                    id: pmAdvanceId
                }
            });
            if (!advance) {
                return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: "PM Advance not found"
                }, {
                    status: 404
                });
            }
        }
        // Create accounting note
        const accountingNote = await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].accountingNote.create({
            data: {
                projectId,
                unitId,
                createdByUserId: session.user.id,
                description: normalizedDescription,
                amount: parsedAmount,
                status: "PENDING",
                sourceType,
                pmAdvanceId: sourceType === "PM_ADVANCE" ? pmAdvanceId : null
            },
            include: {
                unit: {
                    include: {
                        project: true
                    }
                },
                project: true,
                createdByUser: {
                    select: {
                        id: true,
                        name: true,
                        email: true
                    }
                },
                pmAdvance: {
                    include: {
                        staff: {
                            select: {
                                id: true,
                                name: true
                            }
                        }
                    }
                }
            }
        });
        return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json(accountingNote, {
            status: 201
        });
    } catch (error) {
        console.error("Error creating accounting note:", error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "Failed to create accounting note"
        }, {
            status: 500
        });
    }
}
async function PATCH(req) {
    try {
        const session = await (0, __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2d$auth$2f$index$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["getServerSession"])(__TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$auth$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["authOptions"]);
        if (!session?.user?.id) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Unauthorized"
            }, {
                status: 401
            });
        }
        // Only Accountant and Admin can record (convert) notes
        if (session.user.role !== "ACCOUNTANT" && session.user.role !== "ADMIN") {
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Forbidden"
            }, {
                status: 403
            });
        }
        const body = await req.json();
        const { noteId, sourceType, pmAdvanceId } = body;
        if (!noteId) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Missing required field: noteId"
            }, {
                status: 400
            });
        }
        // Fetch accounting note
        const note = await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].accountingNote.findUnique({
            where: {
                id: noteId
            },
            include: {
                unit: {
                    include: {
                        project: true
                    }
                },
                project: true,
                convertedToExpense: {
                    include: {
                        recordedByUser: {
                            select: {
                                id: true,
                                name: true,
                                email: true
                            }
                        }
                    }
                },
                pmAdvance: true
            }
        });
        if (!note) {
            console.error("âŒ Note not found:", noteId);
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Accounting note not found"
            }, {
                status: 404
            });
        }
        console.log("âœ“ Note found:", {
            id: note.id,
            status: note.status,
            amount: note.amount,
            unitId: note.unitId,
            projectId: note.projectId
        });
        if (note.status !== "PENDING") {
            console.error("âŒ Note already recorded:", note.status);
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "This note has already been recorded",
                status: note.status
            }, {
                status: 400
            });
        }
        const resolvedSourceType = sourceType ?? note.sourceType;
        const resolvedPmAdvanceId = pmAdvanceId ?? note.pmAdvanceId;
        if (resolvedSourceType !== "OFFICE_FUND" && resolvedSourceType !== "PM_ADVANCE") {
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "Invalid source type"
            }, {
                status: 400
            });
        }
        if (resolvedSourceType === "PM_ADVANCE" && !resolvedPmAdvanceId) {
            return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                error: "PM advance is required when source type is PM_ADVANCE"
            }, {
                status: 400
            });
        }
        // Validate PM Advance if sourceType is PM_ADVANCE
        if (resolvedSourceType === "PM_ADVANCE" && resolvedPmAdvanceId) {
            const pmAdvance = await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].pMAdvance.findUnique({
                where: {
                    id: resolvedPmAdvanceId
                }
            });
            if (!pmAdvance) {
                console.error("âŒ PM Advance not found:", resolvedPmAdvanceId);
                return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: "PM Advance not found"
                }, {
                    status: 404
                });
            }
            if (pmAdvance.remainingAmount < note.amount) {
                console.error("âŒ Insufficient balance:", {
                    remaining: pmAdvance.remainingAmount,
                    needed: note.amount
                });
                return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
                    error: "Insufficient PM Advance balance",
                    remaining: pmAdvance.remainingAmount,
                    needed: note.amount
                }, {
                    status: 400
                });
            }
            console.log("âœ“ PM Advance validated:", {
                id: resolvedPmAdvanceId,
                remaining: pmAdvance.remainingAmount
            });
        } else if (resolvedSourceType === "PM_ADVANCE" && !resolvedPmAdvanceId) {
            console.warn("âš  PM_ADVANCE selected but no pmAdvanceId provided");
        }
        // Get or create owner association for this unit
        let ownerAssociation = await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].ownerAssociation.findFirst({
            where: {
                unitId: note.unitId
            }
        });
        if (!ownerAssociation) {
            console.log("ðŸ”¨ Creating new owner association for unit:", note.unitId);
            ownerAssociation = await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].ownerAssociation.create({
                data: {
                    name: `Owner - ${note.unit.name}`,
                    unitId: note.unitId,
                    phone: "",
                    email: ""
                }
            });
            console.log("âœ“ Owner association created:", ownerAssociation.id);
        } else {
            console.log("âœ“ Owner association found:", ownerAssociation.id);
        }
        // Create a CLAIM invoice for this note
        const invoiceNumber = `CLM-${Date.now()}-${note.unit.code}`;
        console.log("ðŸ”¨ Creating invoice:", invoiceNumber);
        const invoice = await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].invoice.create({
            data: {
                invoiceNumber,
                type: "CLAIM",
                unitId: note.unitId,
                ownerAssociationId: ownerAssociation.id,
                amount: note.amount,
                remainingBalance: note.amount
            }
        });
        console.log("âœ“ Invoice created:", {
            id: invoice.id,
            invoiceNumber,
            amount: invoice.amount
        });
        // Create operational expense record
        console.log("ðŸ”¨ Creating operational expense");
        const expense = await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].operationalExpense.create({
            data: {
                description: note.description,
                amount: note.amount,
                sourceType: resolvedSourceType,
                unitId: note.unitId,
                claimInvoiceId: invoice.id,
                recordedByUserId: session.user.id,
                pmAdvanceId: resolvedSourceType === "PM_ADVANCE" ? resolvedPmAdvanceId : null,
                convertedFromNoteId: noteId // Link back to the accounting note
            }
        });
        console.log("âœ“ Operational expense created:", {
            id: expense.id,
            sourceType: resolvedSourceType,
            amount: expense.amount
        });
        // Deduct from PM Advance if applicable
        if (resolvedSourceType === "PM_ADVANCE" && resolvedPmAdvanceId) {
            console.log("ðŸ’° Deducting from PM Advance:", {
                pmAdvanceId: resolvedPmAdvanceId,
                amount: note.amount
            });
            await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].pMAdvance.update({
                where: {
                    id: resolvedPmAdvanceId
                },
                data: {
                    remainingAmount: {
                        decrement: note.amount
                    }
                }
            });
            console.log("âœ“ PM Advance deducted successfully");
        }
        // Update accounting note status
        console.log("ðŸ”¨ Updating note status to CONVERTED");
        await __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$src$2f$lib$2f$db$2e$ts__$5b$app$2d$route$5d$__$28$ecmascript$29$__["db"].accountingNote.update({
            where: {
                id: noteId
            },
            data: {
                status: "CONVERTED",
                convertedToExpenseId: expense.id,
                convertedAt: new Date(),
                pmAdvanceId: resolvedSourceType === "PM_ADVANCE" ? resolvedPmAdvanceId : null,
                sourceType: resolvedSourceType
            }
        });
        console.log("âœ“ Note updated to CONVERTED");
        return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            success: true,
            message: "âœ“ Accounting note recorded successfully. Invoice created.",
            invoice,
            expense,
            invoiceNumber: invoice.invoiceNumber
        });
    } catch (error) {
        console.error("âŒ Error recording accounting note:", error);
        const errorMessage = error instanceof Error ? error.message : String(error);
        return __TURBOPACK__imported__module__$5b$project$5d2f$Desktop$2f$cmd$2d$main$2f$node_modules$2f$next$2f$server$2e$js__$5b$app$2d$route$5d$__$28$ecmascript$29$__["NextResponse"].json({
            error: "Failed to record accounting note",
            details: errorMessage
        }, {
            status: 500
        });
    }
}
}),
];

//# sourceMappingURL=%5Broot-of-the-server%5D__664a6776._.js.map