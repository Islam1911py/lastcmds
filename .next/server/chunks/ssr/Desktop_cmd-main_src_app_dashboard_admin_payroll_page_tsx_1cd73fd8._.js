module.exports=[33458,a=>{"use strict";var b=a.i(43713),c=a.i(68599),d=a.i(84642),e=a.i(17545),f=a.i(49015),g=a.i(33347),h=a.i(49466),i=a.i(79059),j=a.i(72760),k=a.i(22488),l=a.i(22654),m=a.i(8569),n=a.i(65189),o=a.i(63395),p=a.i(77726),q=a.i(48421),r=a.i(61977),s=a.i(59627),t=a.i(84194);function u(){let{data:a,status:u}=(0,d.useSession)(),v=(0,e.useRouter)(),{toast:w}=(0,t.useToast)(),[x,y]=(0,c.useState)([]),[z,A]=(0,c.useState)(!0),[B,C]=(0,c.useState)(!1),[D,E]=(0,c.useState)(!1),[F,G]=(0,c.useState)(null),[H,I]=(0,c.useState)(""),[J,K]=(0,c.useState)(!1),[L,M]=(0,c.useState)(!1),[N,O]=(0,c.useState)(null),P=(0,c.useRef)(null),Q=(a,b)=>{try{return new Intl.NumberFormat("ar-EG",{style:"currency",currency:b,minimumFractionDigits:2,maximumFractionDigits:2}).format(a)}catch(c){return console.error("formatCurrency error",c),`${a.toFixed(2)} ${b}`}},R=a=>{if(!a)return"-";try{return new Date(a).toLocaleDateString("ar-EG")}catch(b){return console.error("formatDate error",b),a}};(0,c.useEffect)(()=>{if("loading"!==u&&a){if("ADMIN"!==a.user.role&&"ACCOUNTANT"!==a.user.role)return void v.replace("/dashboard");S()}},[u,a]);let S=async()=>{try{A(!0);let a=await fetch("/api/payroll");if(a.ok){let b=await a.json();y(Array.isArray(b)?b:[])}}catch(a){console.error("Error fetching payrolls:",a)}finally{A(!1)}},T=async a=>{if(a.preventDefault(),H)try{E(!0),(await fetch("/api/payroll",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({month:H})})).ok&&(I(""),C(!1),S())}catch(a){console.error("Error creating payroll:",a)}finally{E(!1)}},U=async a=>{try{G(a);let b=await fetch(`/api/payroll/${a}`,{method:"PATCH",headers:{"Content-Type":"application/json"},body:JSON.stringify({action:"pay"})});if(b.ok)S();else{let a=await b.json();console.error("Error paying payroll:",a)}}catch(a){console.error("Error paying payroll:",a)}finally{G(null)}},V=async(a,b)=>{K(!0),M(!0),O(null);try{let c=await fetch(`/api/payroll/${a}/statement?staffId=${b}`);if(!c.ok){let a=await c.json().catch(()=>({}));throw Error(a?.error||"Failed to load statement")}let d=await c.json();O(d)}catch(a){console.error("Error fetching statement:",a),w({title:"خطأ",description:"تعذر تحميل البيان الخاص بالموظف",variant:"destructive"}),K(!1),O(null)}finally{M(!1)}};if(z)return(0,b.jsx)("div",{className:"flex items-center justify-center min-h-screen",children:(0,b.jsx)(i.Loader,{className:"h-8 w-8 animate-spin text-emerald-500"})});let W=x.reduce((a,b)=>a+b.totalGross,0),X=x.reduce((a,b)=>a+b.totalAdvances,0),Y=x.reduce((a,b)=>a+b.totalNet,0);return(0,b.jsxs)("div",{className:"flex-1 p-8 lg:p-12 overflow-y-auto",children:[(0,b.jsxs)("div",{className:"max-w-7xl mx-auto space-y-8",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsxs)("h1",{className:"text-3xl font-semibold text-gray-900 mb-2 flex items-center gap-3",children:[(0,b.jsx)("div",{className:"p-2.5 bg-gray-100 rounded-md",children:(0,b.jsx)(f.DollarSign,{className:"h-6 w-6 text-gray-600"})}),"الرواتب الشهرية"]}),(0,b.jsx)("p",{className:"text-gray-500",children:"إدارة ودفع رواتب الموظفين"})]}),(0,b.jsxs)(q.Dialog,{open:B,onOpenChange:C,children:[(0,b.jsx)(q.DialogTrigger,{asChild:!0,children:(0,b.jsxs)(o.Button,{className:"bg-[#2563EB] hover:bg-[#1D4ED8] text-white gap-2",children:[(0,b.jsx)(k.Plus,{className:"h-4 w-4"}),"راتب جديد"]})}),(0,b.jsxs)(q.DialogContent,{className:"bg-white",children:[(0,b.jsxs)(q.DialogHeader,{children:[(0,b.jsx)(q.DialogTitle,{className:"text-gray-900",children:"إنشاء كشف رواتب جديد"}),(0,b.jsx)(q.DialogDescription,{className:"text-gray-500",children:"حدد الشهر لإنشاء كشف الرواتب"})]}),(0,b.jsxs)("form",{onSubmit:T,className:"space-y-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(r.Label,{className:"text-gray-500",children:"الشهر"}),(0,b.jsx)(s.Input,{type:"month",value:H,onChange:a=>I(a.target.value),className:"bg-white border-gray-200 text-gray-900 mt-2"})]}),(0,b.jsxs)("div",{className:"flex gap-2 justify-end",children:[(0,b.jsx)(o.Button,{type:"button",variant:"outline",onClick:()=>C(!1),className:"border-gray-300 text-gray-700 hover:bg-gray-50",children:"إلغاء"}),(0,b.jsx)(o.Button,{type:"submit",disabled:D||!H,className:"bg-[#2563EB] hover:bg-[#1D4ED8] text-white",children:D?"جاري الإنشاء...":"إنشاء"})]})]})]})]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[(0,b.jsxs)("div",{className:"bg-white border border-[#E5E7EB] rounded-[12px] p-4 shadow-sm",children:[(0,b.jsx)("div",{className:"flex items-start justify-between mb-3",children:(0,b.jsx)("div",{className:"p-2.5 bg-gray-100 rounded-md",children:(0,b.jsx)(g.TrendingUp,{className:"w-5 h-5 text-gray-600"})})}),(0,b.jsx)("p",{className:"text-gray-500 text-sm mb-1",children:"إجمالي الرواتب الأساسية"}),(0,b.jsx)("p",{className:"text-3xl font-semibold text-gray-900",children:W.toFixed(2)}),(0,b.jsx)("p",{className:"text-xs text-gray-500 mt-2",children:"جنيه مصري"})]}),(0,b.jsxs)("div",{className:"bg-white border border-[#E5E7EB] rounded-[12px] p-4 shadow-sm",children:[(0,b.jsx)("div",{className:"flex items-start justify-between mb-3",children:(0,b.jsx)("div",{className:"p-2.5 bg-gray-100 rounded-md",children:(0,b.jsx)(j.AlertCircle,{className:"w-5 h-5 text-gray-600"})})}),(0,b.jsx)("p",{className:"text-gray-500 text-sm mb-1",children:"إجمالي السلفات المخصومة"}),(0,b.jsx)("p",{className:"text-3xl font-semibold text-gray-900",children:X.toFixed(2)}),(0,b.jsx)("p",{className:"text-xs text-gray-500 mt-2",children:"جنيه مصري"})]}),(0,b.jsxs)("div",{className:"bg-white border border-[#E5E7EB] rounded-[12px] p-4 shadow-sm",children:[(0,b.jsx)("div",{className:"flex items-start justify-between mb-3",children:(0,b.jsx)("div",{className:"p-2.5 bg-gray-100 rounded-md",children:(0,b.jsx)(f.DollarSign,{className:"w-5 h-5 text-gray-600"})})}),(0,b.jsx)("p",{className:"text-gray-500 text-sm mb-1",children:"الراتب الصافي الإجمالي"}),(0,b.jsx)("p",{className:"text-3xl font-semibold text-gray-900",children:Y.toFixed(2)}),(0,b.jsx)("p",{className:"text-xs text-gray-500 mt-2",children:"جنيه مصري"})]})]}),(0,b.jsxs)("div",{className:"bg-white border border-[#E5E7EB] rounded-[12px] p-4 shadow-sm",children:[(0,b.jsx)("h2",{className:"text-base font-semibold text-gray-900 mb-4",children:"كشوفات الرواتب"}),0===x.length?(0,b.jsxs)("div",{className:"text-center py-12 text-gray-500",children:[(0,b.jsx)(h.Users,{className:"h-12 w-12 mx-auto opacity-50 mb-2 text-gray-400"}),(0,b.jsx)("p",{children:"لا توجد كشوفات رواتب"})]}):(0,b.jsx)("div",{className:"space-y-4",children:x.map(a=>(0,b.jsxs)("div",{className:"border border-[#E5E7EB] rounded-[12px] p-4",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between mb-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsxs)("h3",{className:"text-base font-semibold text-gray-900",children:["شهر ",a.month]}),(0,b.jsxs)("p",{className:"text-sm text-gray-500",children:[a.payrollItems.length," موظف"]})]}),(0,b.jsx)(n.Badge,{className:"PAID"===a.status?"bg-[#ECFDF5] border border-[#16A34A]/20 text-[#16A34A]":"bg-[#FFFBEB] border border-[#F59E0B]/20 text-[#F59E0B]",variant:"outline",children:"PAID"===a.status?"مدفوع":"معلق"})]}),(0,b.jsx)("div",{className:"overflow-x-auto",children:(0,b.jsxs)(p.Table,{children:[(0,b.jsx)(p.TableHeader,{children:(0,b.jsxs)(p.TableRow,{children:[(0,b.jsx)(p.TableHead,{children:"الموظف"}),(0,b.jsx)(p.TableHead,{className:"text-right",children:"الراتب الأساسي"}),(0,b.jsx)(p.TableHead,{className:"text-right",children:"السلفات"}),(0,b.jsx)(p.TableHead,{className:"text-right",children:"الصافي"}),(0,b.jsx)(p.TableHead,{className:"text-center",children:"البيان"})]})}),(0,b.jsx)(p.TableBody,{children:a.payrollItems.map(c=>(0,b.jsxs)(p.TableRow,{children:[(0,b.jsx)(p.TableCell,{className:"text-gray-900 font-semibold",children:c.name}),(0,b.jsx)(p.TableCell,{className:"text-right text-gray-500",children:c.salary.toFixed(2)}),(0,b.jsxs)(p.TableCell,{className:"text-right text-gray-900",children:["-",c.advances.toFixed(2)]}),(0,b.jsx)(p.TableCell,{className:"text-right text-gray-900 font-semibold",children:c.net.toFixed(2)}),(0,b.jsx)(p.TableCell,{className:"text-center",children:(0,b.jsxs)(o.Button,{size:"sm",variant:"outline",className:"border-gray-300 text-gray-700 hover:bg-gray-100",onClick:()=>V(a.id,c.staffId),children:[(0,b.jsx)(l.FileText,{className:"h-4 w-4 ml-2"}),"عرض البيان"]})})]},c.id))})]})}),(0,b.jsxs)("div",{className:"mt-4 flex justify-between items-center text-sm",children:[(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsxs)("p",{className:"text-gray-500",children:["إجمالي الأساسي:"," ",(0,b.jsx)("span",{className:"text-gray-900 font-semibold",children:a.totalGross.toFixed(2)})]}),(0,b.jsxs)("p",{className:"text-gray-500",children:["إجمالي السلفات:"," ",(0,b.jsx)("span",{className:"text-gray-900 font-semibold",children:a.totalAdvances.toFixed(2)})]}),(0,b.jsxs)("p",{className:"text-gray-500",children:["الإجمالي الصافي:"," ",(0,b.jsx)("span",{className:"text-gray-900 font-semibold",children:a.totalNet.toFixed(2)})]})]}),"PENDING"===a.status&&(0,b.jsx)(o.Button,{size:"sm",className:"bg-emerald-500 hover:bg-emerald-600",disabled:F===a.id,onClick:()=>U(a.id),children:F===a.id?"جاري المعالجة...":"تم الدفع"})]})]},a.id))})]})]}),(0,b.jsx)(q.Dialog,{open:J,onOpenChange:a=>{K(a),a||(O(null),M(!1))},children:(0,b.jsxs)(q.DialogContent,{className:"bg-white max-w-3xl",children:[(0,b.jsxs)(q.DialogHeader,{children:[(0,b.jsx)(q.DialogTitle,{className:"text-gray-900",children:"بيان راتب الموظف"}),(0,b.jsx)(q.DialogDescription,{className:"text-gray-500",children:"مراجعة تفاصيل الراتب والسلفات للموظف المختار"})]}),L?(0,b.jsx)("div",{className:"flex items-center justify-center py-12",children:(0,b.jsx)(i.Loader,{className:"h-6 w-6 animate-spin text-emerald-500"})}):N?(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h3",{className:"text-lg font-semibold text-gray-900",children:N.staff.name}),(0,b.jsxs)("p",{className:"text-sm text-gray-500",children:["شهر ",N.payroll.month," • الحالة: ","PAID"===N.payroll.status?"مدفوع":"معلق"]})]}),(0,b.jsxs)(o.Button,{variant:"outline",onClick:()=>{if(!N||!P.current)return;let a=P.current.innerHTML,b=window.open("","_blank","width=900,height=1200");b?(b.document.write(`
      <html>
        <head>
          <title>بيان الراتب - ${N.staff.name}</title>
          <style>
            body { font-family: Arial, sans-serif; padding: 32px; direction: rtl; }
            h1, h2, h3 { margin: 0; }
            .header { text-align: center; margin-bottom: 24px; }
            .section { margin-bottom: 16px; }
            table { width: 100%; border-collapse: collapse; margin-top: 12px; }
            th, td { border: 1px solid #ccc; padding: 8px; text-align: right; }
            th { background-color: #f5f5f5; }
            .totals { font-size: 16px; margin-top: 16px; }
            .totals span { display: block; margin-bottom: 4px; }
          </style>
        </head>
        <body>
          ${a}
        </body>
      </html>
    `),b.document.close(),b.focus(),setTimeout(()=>{b.print(),b.close()},300)):w({title:"خطأ",description:"تعذر فتح نافذة الطباعة",variant:"destructive"})},className:"self-start border-gray-300 text-gray-700 hover:bg-gray-50",children:[(0,b.jsx)(m.Printer,{className:"h-4 w-4 ml-2"}),"طباعة / PDF"]})]}),(0,b.jsxs)("div",{ref:P,className:"space-y-6 text-right",dir:"rtl",children:[(0,b.jsxs)("div",{className:"space-y-1",children:[(0,b.jsx)("h2",{className:"text-xl font-semibold text-gray-900",children:"بيان راتب الموظف"}),(0,b.jsxs)("p",{className:"text-sm text-gray-500",children:["الشهر: ",N.payroll.month]}),(0,b.jsxs)("p",{className:"text-sm text-gray-500",children:["تاريخ الإصدار: ",new Date().toLocaleDateString("ar-EG")]})]}),(0,b.jsxs)("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4 text-sm",children:[(0,b.jsxs)("div",{className:"space-y-1 bg-gray-50 border border-gray-200 rounded-lg p-4",children:[(0,b.jsx)("p",{className:"text-gray-500",children:"الموظف"}),(0,b.jsx)("p",{className:"text-gray-900 font-semibold",children:N.staff.name}),(0,b.jsxs)("p",{className:"text-gray-500",children:["الدور الوظيفي: ",N.staff.role]}),(0,b.jsxs)("p",{className:"text-gray-500",children:["الوحدة الأساسية: ",N.staff.unit?.name||"-"," (",N.staff.unit?.code||"-",")"]}),(0,b.jsxs)("p",{className:"text-gray-500",children:["المشروع: ",N.staff.unit?.project?.name||"-"]}),(0,b.jsxs)("p",{className:"text-gray-500",children:["رقم الهاتف: ",N.staff.phone||"-"]})]}),(0,b.jsxs)("div",{className:"space-y-2 bg-gray-50 border border-gray-200 rounded-lg p-4",children:[(0,b.jsx)("p",{className:"text-gray-500",children:"ملخص الراتب"}),(0,b.jsxs)("div",{className:"space-y-1 text-gray-900 font-semibold",children:[(0,b.jsxs)("p",{children:["الراتب الأساسي: ",Q(N.totals.baseSalary,N.currency)]}),(0,b.jsxs)("p",{children:["إجمالي السلفات: ",Q(N.totals.advances,N.currency)]}),(0,b.jsxs)("p",{children:["الصافي المستحق: ",Q(N.totals.net,N.currency)]})]}),(0,b.jsxs)("div",{className:"text-xs text-gray-500",children:[(0,b.jsxs)("p",{children:["السلفات المعلقة: ",Q(N.totals.pendingAdvances,N.currency)]}),(0,b.jsxs)("p",{children:["السلفات المخصومة: ",Q(N.totals.deductedAdvances,N.currency)]})]})]})]}),N.pendingAdvances.length>0&&(0,b.jsxs)("div",{className:"space-y-3",children:[(0,b.jsx)("h4",{className:"text-md font-semibold text-gray-900",children:"السلفات المعلقة"}),(0,b.jsxs)("table",{className:"w-full border border-gray-200 text-sm",children:[(0,b.jsx)("thead",{className:"bg-gray-50",children:(0,b.jsxs)("tr",{children:[(0,b.jsx)("th",{className:"border border-gray-200 p-2",children:"التاريخ"}),(0,b.jsx)("th",{className:"border border-gray-200 p-2",children:"المبلغ"}),(0,b.jsx)("th",{className:"border border-gray-200 p-2",children:"الملاحظات"})]})}),(0,b.jsx)("tbody",{children:N.pendingAdvances.map(a=>(0,b.jsxs)("tr",{children:[(0,b.jsx)("td",{className:"border border-gray-200 p-2",children:R(a.date)}),(0,b.jsx)("td",{className:"border border-gray-200 p-2",children:Q(a.amount,N.currency)}),(0,b.jsx)("td",{className:"border border-gray-200 p-2",children:a.note||"-"})]},a.id))})]})]}),N.deductedAdvances.length>0&&(0,b.jsxs)("div",{className:"space-y-3",children:[(0,b.jsx)("h4",{className:"text-md font-semibold text-gray-900",children:"السلفات المخصومة عبر هذا الكشف"}),(0,b.jsxs)("table",{className:"w-full border border-gray-200 text-sm",children:[(0,b.jsx)("thead",{className:"bg-gray-50",children:(0,b.jsxs)("tr",{children:[(0,b.jsx)("th",{className:"border border-gray-200 p-2",children:"التاريخ"}),(0,b.jsx)("th",{className:"border border-gray-200 p-2",children:"المبلغ"}),(0,b.jsx)("th",{className:"border border-gray-200 p-2",children:"الملاحظات"})]})}),(0,b.jsx)("tbody",{children:N.deductedAdvances.map(a=>(0,b.jsxs)("tr",{children:[(0,b.jsx)("td",{className:"border border-gray-200 p-2",children:R(a.date)}),(0,b.jsx)("td",{className:"border border-gray-200 p-2",children:Q(a.amount,N.currency)}),(0,b.jsx)("td",{className:"border border-gray-200 p-2",children:a.note||"-"})]},a.id))})]})]}),(0,b.jsxs)("div",{className:"text-sm text-gray-500",children:[(0,b.jsxs)("p",{children:["تم إنشاء البيان بواسطة: ",N.payroll.createdBy?.name||"-"]}),(0,b.jsxs)("p",{children:["تاريخ إنشاء الكشف الأصلي: ",R(N.payroll.createdAt)]}),(0,b.jsxs)("p",{children:["تاريخ الدفع: ","PAID"===N.payroll.status?R(N.payroll.paidAt):"لم يتم الدفع بعد"]})]})]})]}):(0,b.jsx)("p",{className:"text-sm text-gray-500",children:"اختر موظفاً لعرض البيان الخاص به."})]})})]})}a.s(["default",()=>u])}];

//# sourceMappingURL=Desktop_cmd-main_src_app_dashboard_admin_payroll_page_tsx_1cd73fd8._.js.map