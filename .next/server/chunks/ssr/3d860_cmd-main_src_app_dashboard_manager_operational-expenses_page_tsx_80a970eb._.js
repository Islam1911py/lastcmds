module.exports=[72216,a=>{"use strict";var b=a.i(43713),c=a.i(68599),d=a.i(84194),e=a.i(57684),f=a.i(63395),g=a.i(59627),h=a.i(61977),i=a.i(48367),j=a.i(48421),k=a.i(77726),l=a.i(65189),m=a.i(84177),n=a.i(66128),o=a.i(72760),p=a.i(22488);let q="__ALL_PROJECTS__",r={projectId:"",unitId:"",description:"",amount:"",sourceType:"OFFICE_FUND",pmAdvanceId:""};function s(a){return new Intl.NumberFormat("ar-EG",{style:"currency",currency:"EGP",minimumFractionDigits:2}).format(a)}function t(a){return new Intl.DateTimeFormat("ar-EG",{dateStyle:"medium",timeStyle:"short"}).format(new Date(a))}function u(){let{toast:a}=(0,d.useToast)(),[u,v]=(0,c.useState)([]),[w,x]=(0,c.useState)([]),[y,z]=(0,c.useState)([]),[A,B]=(0,c.useState)([]),[C,D]=(0,c.useState)([]),[E,F]=(0,c.useState)(r),[G,H]=(0,c.useState)(!1),[I,J]=(0,c.useState)(!0),[K,L]=(0,c.useState)(!0),[M,N]=(0,c.useState)(!1),[O,P]=(0,c.useState)(null);async function Q(){try{let a=await fetch("/api/projects");if(!a.ok)throw Error("Failed to load projects");let b=await a.json(),c=(Array.isArray(b)?b:[]).map(a=>({id:a.id,name:a.name}));v(c)}catch(b){console.error("Error fetching projects",b),a({title:"خطأ",description:"تعذر تحميل المشاريع",variant:"destructive"})}}async function R(b){try{let a=await fetch(`/api/operational-units?projectId=${b}`);if(!a.ok)throw Error("Failed to load units");let c=await a.json(),d=(Array.isArray(c)?c:[]).map(a=>({id:a.id,name:a.name,code:a.code,projectId:a.projectId}));x(d)}catch(b){console.error("Error fetching units",b),a({title:"خطأ",description:"تعذر تحميل الوحدات",variant:"destructive"})}}async function S(){try{let a=await fetch("/api/pm-advances");if(!a.ok)throw Error("Failed to load advances");let b=await a.json();z(Array.isArray(b)?b:[])}catch(b){console.error("Error fetching PM advances",b),a({title:"تنبيه",description:"تعذر تحميل العهد المالية",variant:"destructive"})}}async function T(a){try{L(!0);let b=["PENDING","CONVERTED"].map(b=>{let c=new URLSearchParams;return c.set("status",b),a&&c.set("projectId",a),`/api/accounting-notes?${c.toString()}`}),[c,d]=await Promise.all([fetch(b[0]),fetch(b[1])]);if(!c.ok)throw Error("Failed to load pending notes");if(!d.ok)throw Error("Failed to load converted notes");let[e,f]=await Promise.all([c.json(),d.json()]);B(Array.isArray(e)?e:[]),D(Array.isArray(f)?f:[]),P(null)}catch(a){console.error("Error fetching notes",a),P("تعذر تحميل النفقات المسجلة")}finally{L(!1)}}(0,c.useMemo)(()=>u.find(a=>a.id===E.projectId)||null,[u,E.projectId]),(0,c.useEffect)(()=>{(async()=>{try{J(!0),await Promise.all([Q(),T()])}finally{J(!1)}})()},[]),(0,c.useEffect)(()=>{E.projectId?(R(E.projectId),S()):(x([]),z([]))},[E.projectId]);let U=(0,c.useMemo)(()=>E.projectId?y:[],[y,E.projectId]),V=(0,c.useMemo)(()=>E.projectId?A.filter(a=>a.unit.project.id===E.projectId):A,[A,E.projectId]),W=(0,c.useMemo)(()=>E.projectId?C.filter(a=>a.unit.project.id===E.projectId):C,[C,E.projectId]),X=E.projectId&&E.unitId&&E.description.trim().length>0&&E.amount.trim().length>0&&("OFFICE_FUND"===E.sourceType||E.pmAdvanceId);async function Y(b){if(b.preventDefault(),X)try{N(!0);let b=E.projectId,c={unitId:E.unitId,description:E.description.trim(),amount:Number(E.amount),sourceType:E.sourceType};"PM_ADVANCE"===E.sourceType&&(c.pmAdvanceId=E.pmAdvanceId);let d=await fetch("/api/operational-expenses",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(!d.ok){let a=await d.json().catch(()=>({}));throw Error(a.error||"تعذر تسجيل النفقة")}a({title:"تم الحفظ",description:"تم إرسال النفقة للمراجعة المحاسبية"}),H(!1),F({...r,projectId:b}),await T(b)}catch(b){a({title:"خطأ",description:b instanceof Error?b.message:"تعذر تسجيل النفقة",variant:"destructive"})}finally{N(!1)}}let Z={PENDING:{label:"قيد المراجعة",variant:"secondary"},CONVERTED:{label:"مسجلة",variant:"default"},REJECTED:{label:"مرفوضة",variant:"destructive"}};return I?(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h1",{className:"text-3xl font-bold",children:"النفقات التشغيلية"}),(0,b.jsx)("p",{className:"text-muted-foreground",children:"إدارة وإرسال نفقات المشاريع المسندة إليك"})]}),(0,b.jsx)("div",{className:"grid gap-4 md:grid-cols-2",children:[1,2].map(a=>(0,b.jsxs)(e.Card,{children:[(0,b.jsx)(e.CardHeader,{children:(0,b.jsx)(m.Skeleton,{className:"h-5 w-32"})}),(0,b.jsxs)(e.CardContent,{children:[(0,b.jsx)(m.Skeleton,{className:"h-6 w-full"}),(0,b.jsx)(m.Skeleton,{className:"h-6 w-2/3 mt-2"})]})]},a))})]}):(0,b.jsxs)("div",{className:"space-y-6",dir:"rtl",children:[(0,b.jsxs)("div",{className:"flex flex-col gap-4 md:flex-row md:items-center md:justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h1",{className:"text-3xl font-bold",children:"النفقات التشغيلية"}),(0,b.jsx)("p",{className:"text-muted-foreground",children:"أرسل مصروفات الوحدات ليتم مراجعتها من فريق المحاسبة"})]}),(0,b.jsxs)(j.Dialog,{open:G,onOpenChange:a=>{H(a),a||F(a=>({...r,projectId:a.projectId}))},children:[(0,b.jsx)(j.DialogTrigger,{asChild:!0,children:(0,b.jsxs)(f.Button,{children:[(0,b.jsx)(p.Plus,{className:"h-4 w-4 ml-2"}),"نفقة جديدة"]})}),(0,b.jsxs)(j.DialogContent,{dir:"rtl",className:"sm:max-w-lg",children:[(0,b.jsxs)(j.DialogHeader,{children:[(0,b.jsx)(j.DialogTitle,{children:"تسجيل نفقة تشغيلية"}),(0,b.jsx)(j.DialogDescription,{children:"ستظهر هذه النفقة في ملاحظات المحاسب للمراجعة والاعتماد"})]}),(0,b.jsxs)("form",{onSubmit:Y,className:"space-y-4",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(h.Label,{htmlFor:"project",children:"المشروع *"}),(0,b.jsxs)(i.Select,{value:E.projectId,onValueChange:a=>F(b=>({...b,projectId:a,unitId:"",pmAdvanceId:""})),children:[(0,b.jsx)(i.SelectTrigger,{id:"project",children:(0,b.jsx)(i.SelectValue,{placeholder:"اختر المشروع"})}),(0,b.jsx)(i.SelectContent,{children:u.map(a=>(0,b.jsx)(i.SelectItem,{value:a.id,children:a.name},a.id))})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(h.Label,{htmlFor:"unit",children:"الوحدة *"}),(0,b.jsxs)(i.Select,{value:E.unitId,onValueChange:a=>F(b=>({...b,unitId:a})),disabled:!E.projectId,children:[(0,b.jsx)(i.SelectTrigger,{id:"unit",children:(0,b.jsx)(i.SelectValue,{placeholder:E.projectId?"اختر الوحدة":"اختر المشروع أولًا"})}),(0,b.jsx)(i.SelectContent,{children:w.map(a=>(0,b.jsxs)(i.SelectItem,{value:a.id,children:[a.name," (",a.code,")"]},a.id))})]})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(h.Label,{htmlFor:"description",children:"وصف النفقة *"}),(0,b.jsx)(g.Input,{id:"description",placeholder:"مثال: شراء مستلزمات صيانة للوحدة",value:E.description,onChange:a=>F(b=>({...b,description:a.target.value}))})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(h.Label,{htmlFor:"amount",children:"المبلغ (ر.س) *"}),(0,b.jsx)(g.Input,{id:"amount",type:"number",min:"0",step:"0.01",value:E.amount,onChange:a=>F(b=>({...b,amount:a.target.value}))})]}),(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(h.Label,{htmlFor:"source",children:"مصدر النفقة *"}),(0,b.jsxs)(i.Select,{value:E.sourceType,onValueChange:a=>F(b=>({...b,sourceType:a,pmAdvanceId:""})),children:[(0,b.jsx)(i.SelectTrigger,{id:"source",children:(0,b.jsx)(i.SelectValue,{})}),(0,b.jsxs)(i.SelectContent,{children:[(0,b.jsx)(i.SelectItem,{value:"OFFICE_FUND",children:"من صندوق المكتب"}),(0,b.jsx)(i.SelectItem,{value:"PM_ADVANCE",children:"من عهدة مدير المشروع"})]})]})]}),"PM_ADVANCE"===E.sourceType&&(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(h.Label,{htmlFor:"advance",children:"اختر العهدة *"}),(0,b.jsxs)(i.Select,{value:E.pmAdvanceId,onValueChange:a=>F(b=>({...b,pmAdvanceId:a})),children:[(0,b.jsx)(i.SelectTrigger,{id:"advance",children:(0,b.jsx)(i.SelectValue,{placeholder:U.length?"اختر العهدة":"لا توجد عهد متاحة"})}),(0,b.jsx)(i.SelectContent,{children:U.map(a=>(0,b.jsx)(i.SelectItem,{value:a.id,children:(0,b.jsxs)("div",{className:"flex flex-col",children:[(0,b.jsx)("span",{className:"font-medium",children:a.staff?.name||"مدير مشروع"}),(0,b.jsxs)("span",{className:"text-xs text-muted-foreground",children:["متبقي ",s("number"==typeof a.remainingAmount?a.remainingAmount:Number(a.amount)||0),a.project?.name?` • مرتبط بـ ${a.project.name}`:""]})]})},a.id))})]})]}),(0,b.jsxs)(j.DialogFooter,{children:[(0,b.jsx)(f.Button,{type:"button",variant:"outline",onClick:()=>H(!1),disabled:M,children:"إلغاء"}),(0,b.jsx)(f.Button,{type:"submit",disabled:!X||M,children:M?"جاري الإرسال...":"إرسال للمحاسب"})]})]})]})]})]}),O&&(0,b.jsxs)(n.Alert,{variant:"destructive",children:[(0,b.jsx)(o.AlertCircle,{className:"h-4 w-4"}),(0,b.jsx)(n.AlertDescription,{children:O})]}),(0,b.jsxs)(e.Card,{children:[(0,b.jsxs)(e.CardHeader,{children:[(0,b.jsx)(e.CardTitle,{children:"مستخلص سريع"}),(0,b.jsx)(e.CardDescription,{children:"اختر مشروعًا لرؤية النفقات المرتبطة به أو اتركه فارغًا لعرض جميع النفقات التي قمت بتسجيلها"})]}),(0,b.jsx)(e.CardContent,{className:"space-y-4",children:(0,b.jsxs)("div",{className:"flex flex-col gap-3 md:flex-row md:items-center md:justify-between",children:[(0,b.jsxs)("div",{className:"space-y-2",children:[(0,b.jsx)(h.Label,{className:"text-sm font-medium",children:"تصفية حسب المشروع"}),(0,b.jsxs)(i.Select,{value:E.projectId||q,onValueChange:a=>{let b=a===q?"":a;F(a=>({...a,projectId:b,unitId:"",pmAdvanceId:""})),T(b)},children:[(0,b.jsx)(i.SelectTrigger,{className:"md:w-72",children:(0,b.jsx)(i.SelectValue,{placeholder:"كل المشاريع المسندة"})}),(0,b.jsxs)(i.SelectContent,{children:[(0,b.jsx)(i.SelectItem,{value:q,children:"كل المشاريع"}),u.map(a=>(0,b.jsx)(i.SelectItem,{value:a.id,children:a.name},a.id))]})]})]}),(0,b.jsx)("div",{className:"text-sm text-muted-foreground",children:"يظهر هنا كل ما أرسلته للمحاسب إضافة إلى ما تم اعتماده"})]})})]}),(0,b.jsxs)("div",{className:"grid gap-6 lg:grid-cols-2",children:[(0,b.jsxs)(e.Card,{className:"overflow-hidden",children:[(0,b.jsxs)(e.CardHeader,{children:[(0,b.jsx)(e.CardTitle,{children:"نفقات قيد المراجعة"}),(0,b.jsx)(e.CardDescription,{children:"هذه النفقات تنتظر اعتماد فريق المحاسبة"})]}),(0,b.jsx)(e.CardContent,{children:K?(0,b.jsx)("div",{className:"space-y-2",children:[1,2,3].map(a=>(0,b.jsx)(m.Skeleton,{className:"h-14 w-full"},a))}):0===V.length?(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:"لا توجد نفقات قيد الانتظار حاليًا."}):(0,b.jsxs)(k.Table,{children:[(0,b.jsx)(k.TableHeader,{children:(0,b.jsxs)(k.TableRow,{children:[(0,b.jsx)(k.TableHead,{children:"الوحدة"}),(0,b.jsx)(k.TableHead,{children:"المبلغ"}),(0,b.jsx)(k.TableHead,{children:"الوصف"}),(0,b.jsx)(k.TableHead,{children:"تاريخ الإرسال"})]})}),(0,b.jsx)(k.TableBody,{children:V.map(a=>(0,b.jsxs)(k.TableRow,{children:[(0,b.jsxs)(k.TableCell,{children:[(0,b.jsx)("div",{className:"font-medium",children:a.unit.name}),(0,b.jsx)("div",{className:"text-xs text-muted-foreground",children:a.unit.project.name})]}),(0,b.jsx)(k.TableCell,{children:s(a.amount)}),(0,b.jsx)(k.TableCell,{className:"max-w-xs truncate",children:a.description}),(0,b.jsx)(k.TableCell,{children:t(a.createdAt)})]},a.id))})]})})]}),(0,b.jsxs)(e.Card,{className:"overflow-hidden",children:[(0,b.jsxs)(e.CardHeader,{children:[(0,b.jsx)(e.CardTitle,{children:"نفقات معتمدة"}),(0,b.jsx)(e.CardDescription,{children:"نفقات تم تسجيلها في النظام بعد مراجعة المحاسب"})]}),(0,b.jsx)(e.CardContent,{children:K?(0,b.jsx)("div",{className:"space-y-2",children:[1,2,3].map(a=>(0,b.jsx)(m.Skeleton,{className:"h-14 w-full"},a))}):0===W.length?(0,b.jsx)("p",{className:"text-sm text-muted-foreground",children:"لم يتم اعتماد نفقات لهذا الاختيار بعد."}):(0,b.jsxs)(k.Table,{children:[(0,b.jsx)(k.TableHeader,{children:(0,b.jsxs)(k.TableRow,{children:[(0,b.jsx)(k.TableHead,{children:"الوحدة"}),(0,b.jsx)(k.TableHead,{children:"المبلغ"}),(0,b.jsx)(k.TableHead,{children:"الوصف"}),(0,b.jsx)(k.TableHead,{children:"الحالة"})]})}),(0,b.jsx)(k.TableBody,{children:W.map(a=>(0,b.jsxs)(k.TableRow,{children:[(0,b.jsxs)(k.TableCell,{children:[(0,b.jsx)("div",{className:"font-medium",children:a.unit.name}),(0,b.jsx)("div",{className:"text-xs text-muted-foreground",children:t(a.createdAt)})]}),(0,b.jsx)(k.TableCell,{children:s(a.amount)}),(0,b.jsx)(k.TableCell,{className:"max-w-xs truncate",children:a.description}),(0,b.jsx)(k.TableCell,{children:(0,b.jsx)(l.Badge,{variant:Z[a.status].variant,children:Z[a.status].label})})]},a.id))})]})})]})]})]})}a.s(["default",()=>u])}];

//# sourceMappingURL=3d860_cmd-main_src_app_dashboard_manager_operational-expenses_page_tsx_80a970eb._.js.map