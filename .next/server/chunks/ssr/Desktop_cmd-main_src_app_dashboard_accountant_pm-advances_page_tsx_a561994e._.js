module.exports=[15352,a=>{"use strict";var b=a.i(43713),c=a.i(68599),d=a.i(84642),e=a.i(84194),f=a.i(63395),g=a.i(57684),h=a.i(84177),i=a.i(72760),j=a.i(94171),k=a.i(93983),l=a.i(22488),m=a.i(66128),n=a.i(66689),o=a.i(48421),p=a.i(61977),q=a.i(59627),r=a.i(48367);function s(){let{data:a}=(0,d.useSession)(),{toast:s}=(0,e.useToast)(),[t,u]=(0,c.useState)([]),[v,w]=(0,c.useState)(!0),[x,y]=(0,c.useState)(!1),[z,A]=(0,c.useState)(!1),[B,C]=(0,c.useState)([]),[D,E]=(0,c.useState)([]),[F,G]=(0,c.useState)({userId:"",projectId:"",amount:""});(0,c.useEffect)(()=>{(async()=>{try{w(!0);let[a,b,c]=await Promise.all([fetch("/api/pm-advances"),fetch("/api/projects"),fetch("/api/users?role=PROJECT_MANAGER")]);if(a.ok){let b=await a.json();u(Array.isArray(b)?b:[])}if(b.ok){let a=await b.json();C(Array.isArray(a)?a:[])}if(c.ok){let a=await c.json();E(Array.isArray(a)?a:[])}}catch(a){console.error("Error fetching data:",a),s({title:"Error",description:"Failed to load data. Please refresh the page.",variant:"destructive"})}finally{w(!1)}})()},[s]);let H=async a=>{if(a.preventDefault(),!F.userId||!F.projectId||!F.amount)return void s({title:"خطأ",description:"يرجى ملء جميع الحقول المطلوبة",variant:"destructive"});try{A(!0);let a=await fetch("/api/pm-advances",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:F.userId,projectId:F.projectId,amount:parseFloat(F.amount)})});if(!a.ok){let b=await a.json();throw Error(b.error||"Failed to create advance")}(await a.json()).advance;let b=await fetch("/api/pm-advances");if(b.ok){let a=await b.json();u(Array.isArray(a)?a:[])}y(!1),G({userId:"",projectId:"",amount:""}),s({title:"نجح",description:"تم إنشاء العهدة بنجاح"})}catch(a){console.error("Error creating advance:",a),s({title:"خطأ",description:a instanceof Error?a.message:"Failed to create advance",variant:"destructive"})}finally{A(!1)}};if(v)return(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h1",{className:"text-3xl font-bold",children:"عهد مديري المشاريع"}),(0,b.jsx)("p",{className:"text-muted-foreground mt-2",children:"تتبع العهد المخصصة والصرفيات من كل عهدة"})]}),(0,b.jsx)("div",{className:"grid gap-4 md:grid-cols-4",children:[1,2,3,4].map(a=>(0,b.jsxs)(g.Card,{children:[(0,b.jsx)(g.CardHeader,{className:"pb-2",children:(0,b.jsx)(h.Skeleton,{className:"h-4 w-20"})}),(0,b.jsx)(g.CardContent,{children:(0,b.jsx)(h.Skeleton,{className:"h-8 w-32"})})]},a))})]});let I=t.reduce((a,b)=>a+b.amount,0),J=t.reduce((a,b)=>a+b.totalSpent,0),K=t.reduce((a,b)=>a+b.remainingAmount,0);return(0,b.jsxs)("div",{className:"space-y-6",children:[(0,b.jsxs)("div",{className:"flex items-center justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)("h1",{className:"text-3xl font-bold tracking-tight",children:"عهد مديري المشاريع"}),(0,b.jsx)("p",{className:"text-muted-foreground mt-2",children:"تتبع العهد المخصصة والصرفيات من كل عهدة"})]}),(0,b.jsxs)(o.Dialog,{open:x,onOpenChange:y,children:[(0,b.jsx)(o.DialogTrigger,{asChild:!0,children:(0,b.jsxs)(f.Button,{className:"gap-2",children:[(0,b.jsx)(l.Plus,{className:"h-4 w-4"}),"إضافة عهدة جديدة"]})}),(0,b.jsxs)(o.DialogContent,{className:"max-w-md",children:[(0,b.jsxs)(o.DialogHeader,{children:[(0,b.jsx)(o.DialogTitle,{children:"إضافة عهدة جديدة"}),(0,b.jsx)(o.DialogDescription,{children:"خصص عهدة مالية لمدير مشروع معين"})]}),(0,b.jsxs)("form",{onSubmit:H,className:"space-y-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsx)(p.Label,{htmlFor:"manager",children:"مدير المشروع *"}),(0,b.jsxs)(r.Select,{value:F.userId,onValueChange:a=>G({...F,userId:a}),children:[(0,b.jsx)(r.SelectTrigger,{id:"manager",children:(0,b.jsx)(r.SelectValue,{placeholder:"اختر مدير المشروع"})}),(0,b.jsx)(r.SelectContent,{children:D.map(a=>(0,b.jsx)(r.SelectItem,{value:a.id,children:a.name},a.id))})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)(p.Label,{htmlFor:"project",children:"المشروع *"}),(0,b.jsxs)(r.Select,{value:F.projectId,onValueChange:a=>G({...F,projectId:a}),children:[(0,b.jsx)(r.SelectTrigger,{id:"project",children:(0,b.jsx)(r.SelectValue,{placeholder:"اختر المشروع"})}),(0,b.jsx)(r.SelectContent,{children:B.map(a=>(0,b.jsx)(r.SelectItem,{value:a.id,children:a.name},a.id))})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsx)(p.Label,{htmlFor:"amount",children:"المبلغ (جنيه) *"}),(0,b.jsx)(q.Input,{id:"amount",type:"number",step:"0.01",min:"0",placeholder:"0.00",value:F.amount,onChange:a=>G({...F,amount:a.target.value})})]}),(0,b.jsxs)(o.DialogFooter,{children:[(0,b.jsx)(f.Button,{type:"button",variant:"outline",onClick:()=>y(!1),children:"إلغاء"}),(0,b.jsxs)(f.Button,{type:"submit",disabled:z,children:[z&&(0,b.jsx)(j.Loader2,{className:"h-4 w-4 animate-spin ml-2"}),"إضافة العهدة"]})]})]})]})]})]}),(0,b.jsxs)("div",{className:"grid gap-4 md:grid-cols-4",children:[(0,b.jsxs)(g.Card,{children:[(0,b.jsx)(g.CardHeader,{className:"pb-2",children:(0,b.jsx)(g.CardTitle,{className:"text-sm font-medium",children:"إجمالي العهد"})}),(0,b.jsxs)(g.CardContent,{children:[(0,b.jsxs)("div",{className:"text-2xl font-bold",children:[I.toFixed(2)," جنيه"]}),(0,b.jsxs)("p",{className:"text-xs text-muted-foreground mt-1",children:[t.length," عهدة نشطة"]})]})]}),(0,b.jsxs)(g.Card,{children:[(0,b.jsx)(g.CardHeader,{className:"pb-2",children:(0,b.jsx)(g.CardTitle,{className:"text-sm font-medium",children:"المصروف"})}),(0,b.jsxs)(g.CardContent,{children:[(0,b.jsxs)("div",{className:"text-2xl font-bold",children:[J.toFixed(2)," جنيه"]}),(0,b.jsxs)("p",{className:"text-xs text-muted-foreground mt-1",children:[I>0?(J/I*100).toFixed(1):0,"% من الإجمالي"]})]})]}),(0,b.jsxs)(g.Card,{children:[(0,b.jsx)(g.CardHeader,{className:"pb-2",children:(0,b.jsx)(g.CardTitle,{className:"text-sm font-medium",children:"المتبقي"})}),(0,b.jsxs)(g.CardContent,{children:[(0,b.jsxs)("div",{className:"text-2xl font-bold",children:[K.toFixed(2)," جنيه"]}),(0,b.jsxs)("p",{className:"text-xs text-muted-foreground mt-1",children:[I>0?(K/I*100).toFixed(1):0,"% من الإجمالي"]})]})]}),(0,b.jsxs)(g.Card,{children:[(0,b.jsx)(g.CardHeader,{className:"pb-2",children:(0,b.jsx)(g.CardTitle,{className:"text-sm font-medium",children:"تحذير"})}),(0,b.jsxs)(g.CardContent,{children:[(0,b.jsx)("div",{className:"text-2xl font-bold text-red-600",children:t.filter(a=>a.percentageUsed>=80).length}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:"عهد استُنفذت أكثر من 80%"})]})]})]}),(0,b.jsx)("div",{className:"space-y-4",children:0===t.length?(0,b.jsx)(g.Card,{children:(0,b.jsx)(g.CardContent,{className:"pt-6",children:(0,b.jsxs)(m.Alert,{children:[(0,b.jsx)(i.AlertCircle,{className:"h-4 w-4"}),(0,b.jsx)(m.AlertDescription,{children:"لا توجد عهد مسجلة حتى الآن"})]})})}):t.map(a=>(0,b.jsxs)(g.Card,{children:[(0,b.jsx)(g.CardHeader,{className:"pb-3",children:(0,b.jsxs)("div",{className:"flex items-start justify-between",children:[(0,b.jsxs)("div",{children:[(0,b.jsxs)(g.CardTitle,{className:"flex items-center gap-2",children:[a.user.name,a.percentageUsed>=80&&a.percentageUsed<100&&(0,b.jsxs)("span",{className:"inline-block px-2 py-1 bg-yellow-100 text-yellow-800 text-xs rounded-full font-medium",children:["تنبيه: ",a.percentageUsed.toFixed(0),"%"]}),a.percentageUsed>=100&&(0,b.jsx)("span",{className:"inline-block px-2 py-1 bg-red-100 text-red-800 text-xs rounded-full font-medium",children:"استُنفذت"})]}),(0,b.jsxs)(g.CardDescription,{className:"mt-1",children:[a.project.name," • العهدة منذ"," ",new Date(a.createdAt).toLocaleDateString("ar-EG",{year:"numeric",month:"short",day:"numeric"})]})]}),(0,b.jsxs)("div",{className:"text-right",children:[(0,b.jsx)("div",{className:"text-2xl font-bold",children:a.amount.toFixed(2)}),(0,b.jsx)("div",{className:"text-xs text-muted-foreground",children:"جنيه"})]})]})}),(0,b.jsxs)(g.CardContent,{className:"space-y-4",children:[(0,b.jsxs)("div",{children:[(0,b.jsxs)("div",{className:"flex justify-between items-center mb-2",children:[(0,b.jsx)("span",{className:"text-sm font-medium",children:"نسبة الاستهلاك"}),(0,b.jsxs)("span",{className:"text-sm font-bold text-red-600",children:[a.percentageUsed.toFixed(1),"%"]})]}),(0,b.jsx)(n.Progress,{value:a.percentageUsed,className:"h-2"})]}),(0,b.jsxs)("div",{className:"grid grid-cols-3 gap-4",children:[(0,b.jsxs)("div",{className:"p-3 bg-blue-50 rounded-lg",children:[(0,b.jsx)("p",{className:"text-xs text-muted-foreground mb-1",children:"المصروف"}),(0,b.jsx)("p",{className:"text-lg font-bold",children:a.totalSpent.toFixed(2)}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:"جنيه"})]}),(0,b.jsxs)("div",{className:"p-3 bg-green-50 rounded-lg",children:[(0,b.jsx)("p",{className:"text-xs text-muted-foreground mb-1",children:"المتبقي"}),(0,b.jsx)("p",{className:"text-lg font-bold text-green-600",children:a.remainingAmount.toFixed(2)}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:"جنيه"})]}),(0,b.jsxs)("div",{className:"p-3 bg-gray-50 rounded-lg",children:[(0,b.jsx)("p",{className:"text-xs text-muted-foreground mb-1",children:"الأصلي"}),(0,b.jsx)("p",{className:"text-lg font-bold",children:a.amount.toFixed(2)}),(0,b.jsx)("p",{className:"text-xs text-muted-foreground mt-1",children:"جنيه"})]})]}),(0,b.jsxs)("div",{children:[(0,b.jsxs)("h4",{className:"font-semibold text-sm mb-3 flex items-center gap-2",children:[(0,b.jsx)(k.TrendingDown,{className:"h-4 w-4"}),"تفصيل الصرفيات"]}),a.operationalExpenses&&a.operationalExpenses.length>0&&(0,b.jsxs)("div",{className:"mb-4",children:[(0,b.jsx)("p",{className:"text-xs font-medium text-muted-foreground mb-2",children:"نفقات تشغيلية"}),(0,b.jsxs)("div",{className:"space-y-2 ml-4 border-r-2 border-blue-200 pr-4",children:[a.operationalExpenses.slice(0,5).map(a=>(0,b.jsxs)("div",{className:"flex justify-between items-center text-sm",children:[(0,b.jsx)("span",{className:"text-muted-foreground",children:a.description}),(0,b.jsxs)("span",{className:"font-semibold",children:[a.amount.toFixed(2)," جنيه"]})]},a.id)),a.operationalExpenses.length>5&&(0,b.jsxs)("div",{className:"text-xs text-muted-foreground italic",children:["+",a.operationalExpenses.length-5," نفقات أخرى"]})]})]}),a.expenses&&a.expenses.length>0&&(0,b.jsxs)("div",{children:[(0,b.jsx)("p",{className:"text-xs font-medium text-muted-foreground mb-2",children:"نفقات الوحدات"}),(0,b.jsxs)("div",{className:"space-y-2 ml-4 border-r-2 border-purple-200 pr-4",children:[a.expenses.slice(0,5).map(a=>(0,b.jsxs)("div",{className:"flex justify-between items-center text-sm",children:[(0,b.jsxs)("span",{className:"text-muted-foreground",children:[a.unit?.name||"وحدة غير محددة"," - ",a.description]}),(0,b.jsxs)("span",{className:"font-semibold",children:[a.amount.toFixed(2)," جنيه"]})]},a.id)),a.expenses.length>5&&(0,b.jsxs)("div",{className:"text-xs text-muted-foreground italic",children:["+",a.expenses.length-5," نفقات أخرى"]})]})]}),!a.operationalExpenses?.length&&!a.expenses?.length&&(0,b.jsx)("p",{className:"text-sm text-muted-foreground italic",children:"لم يتم تسجيل صرفيات بعد"})]})]})]},a.id))})]})}a.s(["default",()=>s])}];

//# sourceMappingURL=Desktop_cmd-main_src_app_dashboard_accountant_pm-advances_page_tsx_a561994e._.js.map