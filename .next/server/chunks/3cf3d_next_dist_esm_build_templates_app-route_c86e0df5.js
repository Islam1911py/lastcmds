module.exports=[12585,e=>{"use strict";var t=e.i(84170),n=e.i(42650),r=e.i(66780),o=e.i(47811),a=e.i(65257),s=e.i(64764),i=e.i(37146),d=e.i(30274),u=e.i(70255),c=e.i(61189),l=e.i(40827),p=e.i(74297),A=e.i(65491),m=e.i(36365),N=e.i(79260),f=e.i(93695);e.i(34582);var g=e.i(20010),h=e.i(55053),R=e.i(68347),v=e.i(28396),E=e.i(9316);async function w(e){try{let t=await (0,R.getServerSession)(v.authOptions);if(!t)return h.NextResponse.json({error:"Unauthorized"},{status:401});let n=e.nextUrl.searchParams,r=n.get("status"),o=n.get("projectId"),a=[];if(r&&a.push({status:r}),o&&a.push({projectId:o}),"PROJECT_MANAGER"===t.user.role){let e=t.user.projectIds||[];if(!t.user.canViewAllProjects){if(o&&!e.includes(o))return h.NextResponse.json({error:"Forbidden"},{status:403});if(0===e.length)return h.NextResponse.json([]);a.push({OR:[{createdByUserId:t.user.id},{projectId:{in:e}}]})}}else if("ACCOUNTANT"!==t.user.role&&"ADMIN"!==t.user.role)return h.NextResponse.json({error:"Forbidden"},{status:403});let s=a.length>0?{AND:a}:void 0,i=await E.db.accountingNote.findMany({where:s,include:{unit:{include:{project:!0}},project:!0,createdByUser:{select:{id:!0,name:!0,email:!0}},convertedToExpense:{include:{recordedByUser:{select:{id:!0,name:!0,email:!0}}}},pmAdvance:{include:{staff:{select:{id:!0,name:!0}}}}},orderBy:{createdAt:"desc"}});return h.NextResponse.json(i)}catch(e){return console.error("Error fetching accounting notes:",e),h.NextResponse.json({error:"Failed to fetch accounting notes"},{status:500})}}async function C(e){try{let t=await (0,R.getServerSession)(v.authOptions);if(!t)return h.NextResponse.json({error:"Unauthorized"},{status:401});if("PROJECT_MANAGER"!==t.user.role&&"ADMIN"!==t.user.role)return h.NextResponse.json({error:"Forbidden"},{status:403});let{projectId:n,unitId:r,description:o,amount:a,sourceType:s="OFFICE_FUND",pmAdvanceId:i}=await e.json(),d="string"==typeof o?o.trim():"",u=Number(a);if(!n||!r||!d||u<=0||Number.isNaN(u))return h.NextResponse.json({error:"Missing required fields"},{status:400});if("OFFICE_FUND"!==s&&"PM_ADVANCE"!==s)return h.NextResponse.json({error:"Invalid source type. Must be OFFICE_FUND or PM_ADVANCE"},{status:400});if("PM_ADVANCE"===s&&!i)return h.NextResponse.json({error:"pmAdvanceId is required when sourceType is PM_ADVANCE"},{status:400});let c=await E.db.operationalUnit.findUnique({where:{id:r},include:{project:!0}});if(!c)return h.NextResponse.json({error:"Operational unit not found"},{status:404});if(c.projectId!==n)return h.NextResponse.json({error:"Unit does not belong to the specified project"},{status:400});if("PROJECT_MANAGER"===t.user.role&&!await E.db.projectAssignment.findFirst({where:{userId:t.user.id,projectId:n}}))return h.NextResponse.json({error:"You are not assigned to this project"},{status:403});if("PM_ADVANCE"===s&&i&&!await E.db.pMAdvance.findUnique({where:{id:i}}))return h.NextResponse.json({error:"PM Advance not found"},{status:404});let l=await E.db.accountingNote.create({data:{projectId:n,unitId:r,createdByUserId:t.user.id,description:d,amount:u,status:"PENDING",sourceType:s,pmAdvanceId:"PM_ADVANCE"===s?i:null},include:{unit:{include:{project:!0}},project:!0,createdByUser:{select:{id:!0,name:!0,email:!0}},pmAdvance:{include:{staff:{select:{id:!0,name:!0}}}}}});return h.NextResponse.json(l,{status:201})}catch(e){return console.error("Error creating accounting note:",e),h.NextResponse.json({error:"Failed to create accounting note"},{status:500})}}async function x(e){try{let t=await (0,R.getServerSession)(v.authOptions);if(!t?.user?.id)return h.NextResponse.json({error:"Unauthorized"},{status:401});if("ACCOUNTANT"!==t.user.role&&"ADMIN"!==t.user.role)return h.NextResponse.json({error:"Forbidden"},{status:403});let{noteId:n,sourceType:r,pmAdvanceId:o}=await e.json();if(!n)return h.NextResponse.json({error:"Missing required field: noteId"},{status:400});let a=await E.db.accountingNote.findUnique({where:{id:n},include:{unit:{include:{project:!0}},project:!0,convertedToExpense:{include:{recordedByUser:{select:{id:!0,name:!0,email:!0}}}},pmAdvance:!0}});if(!a)return console.error("âŒ Note not found:",n),h.NextResponse.json({error:"Accounting note not found"},{status:404});if(console.log("âœ“ Note found:",{id:a.id,status:a.status,amount:a.amount,unitId:a.unitId,projectId:a.projectId}),"PENDING"!==a.status)return console.error("âŒ Note already recorded:",a.status),h.NextResponse.json({error:"This note has already been recorded",status:a.status},{status:400});let s=r??a.sourceType,i=o??a.pmAdvanceId;if("OFFICE_FUND"!==s&&"PM_ADVANCE"!==s)return h.NextResponse.json({error:"Invalid source type"},{status:400});if("PM_ADVANCE"===s&&!i)return h.NextResponse.json({error:"PM advance is required when source type is PM_ADVANCE"},{status:400});if("PM_ADVANCE"===s&&i){let e=await E.db.pMAdvance.findUnique({where:{id:i}});if(!e)return console.error("âŒ PM Advance not found:",i),h.NextResponse.json({error:"PM Advance not found"},{status:404});if(e.remainingAmount<a.amount)return console.error("âŒ Insufficient balance:",{remaining:e.remainingAmount,needed:a.amount}),h.NextResponse.json({error:"Insufficient PM Advance balance",remaining:e.remainingAmount,needed:a.amount},{status:400});console.log("âœ“ PM Advance validated:",{id:i,remaining:e.remainingAmount})}else"PM_ADVANCE"!==s||i||console.warn("âš  PM_ADVANCE selected but no pmAdvanceId provided");let d=await E.db.ownerAssociation.findFirst({where:{unitId:a.unitId}});d?console.log("âœ“ Owner association found:",d.id):(console.log("ðŸ”¨ Creating new owner association for unit:",a.unitId),d=await E.db.ownerAssociation.create({data:{name:`Owner - ${a.unit.name}`,unitId:a.unitId,phone:"",email:""}}),console.log("âœ“ Owner association created:",d.id));let u=`CLM-${Date.now()}-${a.unit.code}`;console.log("ðŸ”¨ Creating invoice:",u);let c=await E.db.invoice.create({data:{invoiceNumber:u,type:"CLAIM",unitId:a.unitId,ownerAssociationId:d.id,amount:a.amount,remainingBalance:a.amount}});console.log("âœ“ Invoice created:",{id:c.id,invoiceNumber:u,amount:c.amount}),console.log("ðŸ”¨ Creating operational expense");let l=await E.db.operationalExpense.create({data:{description:a.description,amount:a.amount,sourceType:s,unitId:a.unitId,claimInvoiceId:c.id,recordedByUserId:t.user.id,pmAdvanceId:"PM_ADVANCE"===s?i:null,convertedFromNoteId:n}});return console.log("âœ“ Operational expense created:",{id:l.id,sourceType:s,amount:l.amount}),"PM_ADVANCE"===s&&i&&(console.log("ðŸ’° Deducting from PM Advance:",{pmAdvanceId:i,amount:a.amount}),await E.db.pMAdvance.update({where:{id:i},data:{remainingAmount:{decrement:a.amount}}}),console.log("âœ“ PM Advance deducted successfully")),console.log("ðŸ”¨ Updating note status to CONVERTED"),await E.db.accountingNote.update({where:{id:n},data:{status:"CONVERTED",convertedToExpenseId:l.id,convertedAt:new Date,pmAdvanceId:"PM_ADVANCE"===s?i:null,sourceType:s}}),console.log("âœ“ Note updated to CONVERTED"),h.NextResponse.json({success:!0,message:"âœ“ Accounting note recorded successfully. Invoice created.",invoice:c,expense:l,invoiceNumber:c.invoiceNumber})}catch(t){console.error("âŒ Error recording accounting note:",t);let e=t instanceof Error?t.message:String(t);return h.NextResponse.json({error:"Failed to record accounting note",details:e},{status:500})}}e.s(["GET",()=>w,"PATCH",()=>x,"POST",()=>C],45293);var I=e.i(45293);let j=new t.AppRouteRouteModule({definition:{kind:n.RouteKind.APP_ROUTE,page:"/api/accounting-notes/route",pathname:"/api/accounting-notes",filename:"route",bundlePath:""},distDir:".next",relativeProjectDir:"",resolvedPagePath:"[project]/Desktop/cmd-main/src/app/api/accounting-notes/route.ts",nextConfigOutput:"standalone",userland:I}),{workAsyncStorage:y,workUnitAsyncStorage:P,serverHooks:M}=j;function b(){return(0,r.patchFetch)({workAsyncStorage:y,workUnitAsyncStorage:P})}async function T(e,t,r){j.isDev&&(0,o.addRequestMeta)(e,"devRequestTimingInternalsEnd",process.hrtime.bigint());let h="/api/accounting-notes/route";h=h.replace(/\/index$/,"")||"/";let R=await j.prepare(e,t,{srcPage:h,multiZoneDraftMode:!1});if(!R)return t.statusCode=400,t.end("Bad Request"),null==r.waitUntil||r.waitUntil.call(r,Promise.resolve()),null;let{buildId:v,params:E,nextConfig:w,parsedUrl:C,isDraftMode:x,prerenderManifest:I,routerServerContext:y,isOnDemandRevalidate:P,revalidateOnlyGenerated:M,resolvedPathname:b,clientReferenceManifest:T,serverActionsManifest:D}=R,O=(0,i.normalizeAppPath)(h),_=!!(I.dynamicRoutes[O]||I.routes[b]),U=async()=>((null==y?void 0:y.render404)?await y.render404(e,t,C,!1):t.end("This page could not be found"),null);if(_&&!x){let e=!!I.routes[b],t=I.dynamicRoutes[O];if(t&&!1===t.fallback&&!e){if(w.experimental.adapterPath)return await U();throw new f.NoFallbackError}}let F=null;!_||j.isDev||x||(F="/index"===(F=b)?"/":F);let S=!0===j.isDev||!_,q=_&&!S;D&&T&&(0,s.setManifestsSingleton)({page:h,clientReferenceManifest:T,serverActionsManifest:D});let V=e.method||"GET",H=(0,a.getTracer)(),k=H.getActiveScopeSpan(),B={params:E,prerenderManifest:I,renderOpts:{experimental:{authInterrupts:!!w.experimental.authInterrupts},cacheComponents:!!w.cacheComponents,supportsDynamicResponse:S,incrementalCache:(0,o.getRequestMeta)(e,"incrementalCache"),cacheLifeProfiles:w.cacheLife,waitUntil:r.waitUntil,onClose:e=>{t.on("close",e)},onAfterTaskError:void 0,onInstrumentationRequestError:(t,n,r,o)=>j.onRequestError(e,t,r,o,y)},sharedContext:{buildId:v}},$=new d.NodeNextRequest(e),G=new d.NodeNextResponse(t),K=u.NextRequestAdapter.fromNodeNextRequest($,(0,u.signalFromNodeResponse)(t));try{let s=async e=>j.handle(K,B).finally(()=>{if(!e)return;e.setAttributes({"http.status_code":t.statusCode,"next.rsc":!1});let n=H.getRootSpanAttributes();if(!n)return;if(n.get("next.span_type")!==c.BaseServerSpan.handleRequest)return void console.warn(`Unexpected root span type '${n.get("next.span_type")}'. Please report this Next.js issue https://github.com/vercel/next.js`);let r=n.get("next.route");if(r){let t=`${V} ${r}`;e.setAttributes({"next.route":r,"http.route":r,"next.span_name":t}),e.updateName(t)}else e.updateName(`${V} ${h}`)}),i=!!(0,o.getRequestMeta)(e,"minimalMode"),d=async o=>{var a,d;let u=async({previousCacheEntry:n})=>{try{if(!i&&P&&M&&!n)return t.statusCode=404,t.setHeader("x-nextjs-cache","REVALIDATED"),t.end("This page could not be found"),null;let a=await s(o);e.fetchMetrics=B.renderOpts.fetchMetrics;let d=B.renderOpts.pendingWaitUntil;d&&r.waitUntil&&(r.waitUntil(d),d=void 0);let u=B.renderOpts.collectedTags;if(!_)return await (0,p.sendResponse)($,G,a,B.renderOpts.pendingWaitUntil),null;{let e=await a.blob(),t=(0,A.toNodeOutgoingHttpHeaders)(a.headers);u&&(t[N.NEXT_CACHE_TAGS_HEADER]=u),!t["content-type"]&&e.type&&(t["content-type"]=e.type);let n=void 0!==B.renderOpts.collectedRevalidate&&!(B.renderOpts.collectedRevalidate>=N.INFINITE_CACHE)&&B.renderOpts.collectedRevalidate,r=void 0===B.renderOpts.collectedExpire||B.renderOpts.collectedExpire>=N.INFINITE_CACHE?void 0:B.renderOpts.collectedExpire;return{value:{kind:g.CachedRouteKind.APP_ROUTE,status:a.status,body:Buffer.from(await e.arrayBuffer()),headers:t},cacheControl:{revalidate:n,expire:r}}}}catch(t){throw(null==n?void 0:n.isStale)&&await j.onRequestError(e,t,{routerKind:"App Router",routePath:h,routeType:"route",revalidateReason:(0,l.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:P})},!1,y),t}},c=await j.handleResponse({req:e,nextConfig:w,cacheKey:F,routeKind:n.RouteKind.APP_ROUTE,isFallback:!1,prerenderManifest:I,isRoutePPREnabled:!1,isOnDemandRevalidate:P,revalidateOnlyGenerated:M,responseGenerator:u,waitUntil:r.waitUntil,isMinimalMode:i});if(!_)return null;if((null==c||null==(a=c.value)?void 0:a.kind)!==g.CachedRouteKind.APP_ROUTE)throw Object.defineProperty(Error(`Invariant: app-route received invalid cache entry ${null==c||null==(d=c.value)?void 0:d.kind}`),"__NEXT_ERROR_CODE",{value:"E701",enumerable:!1,configurable:!0});i||t.setHeader("x-nextjs-cache",P?"REVALIDATED":c.isMiss?"MISS":c.isStale?"STALE":"HIT"),x&&t.setHeader("Cache-Control","private, no-cache, no-store, max-age=0, must-revalidate");let f=(0,A.fromNodeOutgoingHttpHeaders)(c.value.headers);return i&&_||f.delete(N.NEXT_CACHE_TAGS_HEADER),!c.cacheControl||t.getHeader("Cache-Control")||f.get("Cache-Control")||f.set("Cache-Control",(0,m.getCacheControlHeader)(c.cacheControl)),await (0,p.sendResponse)($,G,new Response(c.value.body,{headers:f,status:c.value.status||200})),null};k?await d(k):await H.withPropagatedContext(e.headers,()=>H.trace(c.BaseServerSpan.handleRequest,{spanName:`${V} ${h}`,kind:a.SpanKind.SERVER,attributes:{"http.method":V,"http.target":e.url}},d))}catch(t){if(t instanceof f.NoFallbackError||await j.onRequestError(e,t,{routerKind:"App Router",routePath:O,routeType:"route",revalidateReason:(0,l.getRevalidateReason)({isStaticGeneration:q,isOnDemandRevalidate:P})},!1,y),_)throw t;return await (0,p.sendResponse)($,G,new Response(null,{status:500})),null}}e.s(["handler",()=>T,"patchFetch",()=>b,"routeModule",()=>j,"serverHooks",()=>M,"workAsyncStorage",()=>y,"workUnitAsyncStorage",()=>P],12585)}];

//# sourceMappingURL=3cf3d_next_dist_esm_build_templates_app-route_c86e0df5.js.map