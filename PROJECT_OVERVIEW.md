# نظرة عامة على المشروع

## 1. مقدمة سريعة
- المنصة مبنية على Next.js (App Router) مع TypeScript وواجهة تعتمد على shadcn/ui وتنسيق Tailwind.
- المصادقة تتم بواسطة NextAuth مع أدوار مخصّصة (ADMIN، ACCOUNTANT، PROJECT_MANAGER، RESIDENT) يتمّ حقنها في الجلسة.
- الطبقة الخلفية تعتمد على Prisma للولوج إلى قاعدة بيانات SQLite (يمكن استبدالها لاحقًا).
- التكامل مع n8n يوفّر قناة واتساب للأهالي ومديري المشاريع والمحاسبين والإدارة لإرسال الطلبات أو الاستعلامات.

## 2. البنية العامة للتطبيق
- **الواجهة الأمامية**: صفحات Dashboard لكل دور (اداري، محاسب، مدير مشروع) مع صفحات إضافية مثل إدارة أرقام الواتساب المصرح بها.
- **واجهات API داخلية**: REST endpoints تحت `src/app/api` لمعالجة التذاكر، المصروفات التشغيلية، الملاحظات المحاسبية، وغير ذلك.
- **التكامل مع n8n**: مجموعة webhooks تحت `src/app/api/webhooks` تتعامل مع الوافد من الـ automations (واتساب أو n8n Workflows).
- **المكتبات المساعدة**: مثل `src/lib/n8n-auth.ts` للتحقق من مفاتيح n8n وإدارة معدل الطلبات، و `src/lib/phone.ts` لتوليد صيغ متعددة للأرقام.

## 3. نماذج البيانات الرئيسية (Prisma)
- **N8nApiKey**: يخزن المفتاح، الدور المرتبط، معدل الطلب، وحالة التفعيل (`prisma/schema.prisma`).
- **Ticket**: شكوى أو طلب خدمة مرتبط بوحدة سكنية ومقيم، مع حالة، أولوية، تصنيف، وردود مقيم.
- **AccountingNote**: ملاحظة مصروفات من مدير مشاريع (أو الإدارة) يتم اعتمادها لاحقًا من المحاسبين.
- **Project / OperationalUnit / Resident**: هرمية المشروع ثم الوحدة ثم المقيم.
- **User**: يستخدم لتخزين موظفي الإدارة/المحاسبين/مديري المشاريع مع أدوارهم وأرقام واتساب المصرح بها.

## 4. الوحدات وواجهات العمل المهمة
- **لوحة التذاكر**: إدارة التذاكر وإظهار الردود من المقيمين، مع دعم تعيين موظفين.
- **لوحة المصروفات المحاسبية**: للمحاسبين لمراجعة ملاحظات PM والتحكم بحالتها.
- **صفحة إدارة جهات الاتصال** (`src/app/dashboard/admin/pm-contacts/page.tsx`): تسمح للمسؤول بتحديث أرقام واتساب للإدارة والمحاسبة ومديري المشاريع وربط المديرين بالمشروعات.
- **واجهات الموظفين**: تشمل الرواتب، السلف، وتحويلات المصروفات التشغيلية.

## 5. تكامل n8n – نظرة عامة
- كل طلب يجب أن يحمل رأس `x-api-key` بمفتاح صالح معرف مسبقًا في جدول `N8nApiKey`.
- التحقق يتم عبر `verifyN8nApiKey` التي تضمن تفعيل المفتاح، عدم تجاوز معدل الطلبات (rate limit)، وربط الطلب بدور المستخدم (role) وربما مشروع محدد.
- كل طلب يتمّ تسجيله في جدول `N8nWebhookLog` مع الاستجابة والأخطاء المحتملة (`logWebhookEvent`).
- يمكن تقييد المفتاح بمشروع واحد (`projectId`). في هذه الحالة لن يسمح له بالتعامل مع وحدات أو مشاريع أخرى.

## 6. نقاط نهاية n8n المتاحة

### 6.1 POST /api/webhooks/tickets
- **الدور المسموح**: RESIDENT فقط.
- **الاستخدام**: إنشاء تذكرة جديدة بناءً على بيانات الواتساب.
- **الحقول الأساسية**: `residentName`, `unitCode`, `title`, `description`, اختيارياً `residentPhone`, `priority`.
- **الاستجابة**: تعيد `ticketId`, `ticketNumber`, بيانات المقيم المحدثة، ورسالة نجاح.
- **ملاحظات**: في حال عدم العثور على المقيم يتم إنشاؤه وربطه بالوحدة.

### 6.2 PUT /api/webhooks/tickets/{id}
- **الأدوار المسموحة**: ADMIN أو PROJECT_MANAGER.
- **الاستخدام**: تحديث حالة التذكرة، إضافة ملاحظات الحل، أو تعيين موظف.
- **الحقول المقبولة**: `status`, `notes` (تُدمج في الوصف), `resolution`, `assignedToId`.
- **الاستجابة**: تعيد بيانات التذكرة المحدثة بالإضافة إلى كائن `n8nCallback` لتبسيط الرد إلى الواتساب.

### 6.3 GET /api/webhooks/tickets/{id}
- **الأدوار المسموحة**: جميع المفاتيح الموثوقة (طالما المفتاح فعّال).
- **الاستخدام**: جلب تفاصيل تذكرة واحدة مع المقيم والوحدة والموظف المعيّن.

### 6.4 POST /api/webhooks/tickets/{id}/notes
- **الأدوار**: أي مفتاح صالح (لم يفرض الدور صراحةً).
- **الاستخدام**: إلحاق ملاحظة نصية بالتذكرة وربما تعديل الحالة.
- **ملاحظات**: يتم إلحاق النص في نهاية الوصف الأصلي مع ختم زمني.

### 6.5 GET /api/webhooks/query
- **الدور يحدد نوع البيانات** (بخلاف RESIDENT الذي يُحظر عليه الاستعلام):
  - `ACCOUNTANT`: إجمالي الفواتير، المدفوعات، ملاحظات المحاسبة المعلّقة.
  - `ADMIN`: ملخص شامل (مشروعات، وحدات، سكان، تذاكر، فنيين، موظفين).
  - `PROJECT_MANAGER`: بيانات مشروع محدد (يستلزم `projectId` في الاستعلام أو في المفتاح)، إحصائيات، سكان، تذاكر اليوم.
- **المعاملات**: `type` لتحديد نوع الاستعلام، `senderPhone` للتحقق من أن الطلب آتٍ من رقم واتساب مسجل، و `projectId` عند الحاجة.

### 6.6 POST /api/webhooks/delivery-orders
- **الدور المسموح**: RESIDENT.
- **الاستخدام**: يسمح للمقيمين بإرسال طلب توصيل عبر n8n.
- **الحقول الأساسية**: `residentPhone`, `unitCode`, `description` أو `orderText`, بالإضافة إلى `projectId` (أو يُستنتج من مفتاح الـ API إن وُجِد).
- **الاستجابة**: تعيد تفاصيل الطلب الذي تم إنشاؤه ورسالة نجاح.
- **التكامل**: يرسل إشعارًا إلى n8n بواسطة `notifyN8nEvent` لتجهيز رسالة واتساب لمدير المشروع.

### 6.7 POST /api/webhooks/accounting-notes
- **الأدوار المسموحة**: PROJECT_MANAGER أو ADMIN.
- **الاستخدام**: تسجيل ملاحظة محاسبية لمشروع/وحدة محددة مع قيمة مالية.
- **الحقول الأساسية**: `unitId`, `description`, `amount`, اختيارياً `reason`, `notes`, `createdByUserId`, `pmPhone`.
- **الاستجابة**: تعيد بيانات الملاحظة، مع رسالة جاهزة لإعادة إرسالها عبر واتساب.
- **التحقق**: إذا كان المفتاح مقيداً بمشروع فيجب أن تتوافق الوحدة مع نفس المشروع. يتم البحث عن المستخدم صاحب الملاحظة بناءً على phone أو id أو الدور.

## 7. صلاحيات الأدوار عبر n8n

| الدور | ما يمكنه فعله عبر الـ API |
| --- | --- |
| RESIDENT | إنشاء تذاكر جديدة (`POST /api/webhooks/tickets`) وطلبات توصيل (`POST /api/webhooks/delivery-orders`). |
| PROJECT_MANAGER | تحديث التذاكر (`PUT /api/webhooks/tickets/{id}`)، إضافة ملاحظات (`POST /tickets/{id}/notes`)، إنشاء ملاحظات محاسبية (`POST /accounting-notes`)، تشغيل استعلامات المشروع (`GET /query?type=...&projectId=...`). |
| ACCOUNTANT | تنفيذ استعلامات محاسبية ومالية (`GET /query?type=ACCOUNTING_DATA`). |
| ADMIN | كل ما سبق + استعلام شامل (`GET /query?type=ALL_DATA`)، تحديث التذاكر، إنشاء ملاحظات محاسبية، إدارة أي مشروع.

## 8. كيفية استخدام واجهات n8n عمليًا
1. إنشاء مفتاح جديد في قاعدة البيانات (عبر لوحة الإدارة أو مباشرة في `N8nApiKey`).
2. ضبط الدور (مثل ACCOUNTANT) وتحديد معدل الطلب والمشروع لو لزم الأمر.
3. ضمن Workflow في n8n، استعمال عقدة HTTP Request:
   - Method حسب العملية (POST, GET, PUT).
   - URL: مثلاً `https://your-domain.com/api/webhooks/query?type=ACCOUNTING_DATA`.
   - Headers: إضافة `x-api-key: <API_KEY>`.
   - Body (في POST/PUT) بصيغة JSON متوافقة مع الحقول المذكورة أعلاه.
4. لتلقي تنبيهات فورية، اضبط المتغير `N8N_NOTIFICATION_WEBHOOK_URL` بحيث يشير إلى Webhook في n8n؛ النظام يرسل تلقائيًا حدث `TICKET_CREATED` أو `DELIVERY_ORDER_CREATED` مع بيانات العنصر.
5. التعامل مع الاستجابة (JSON) في الخطوات التالية داخل n8n لإرسال رسالة واتساب أو تحديث ورقة بيانات.
6. مراقبة السجلات عبر جدول `N8nWebhookLog` أو بناء لوحة مراقبة في n8n باستخدام الاستجابة `message` و `success`.

## 9. نصائح تشغيلية
- حافظ على معدل الطلب (`rateLimit`) متناسبًا مع سيناريو الواتساب حتى لا تُرفض الطلبات.
- عند استخدام PROJECT_MANAGER API تأكد من تمرير `projectId` إذا لم يكن المفتاح مقيداً بمشروع.
- تعامل مع الأخطاء (رموز 4xx/5xx) في n8n لاسترداد الرسائل المناسبة للمستخدم.
- لا تنسَ تحديث أرقام الواتساب المسموح بها من خلال صفحة الإدارة لضمان تمرير التحقق في `GET /api/webhooks/query`.

## 10. روابط مصدرية سريعة
- تحقق المفتاح وتسجيل الأحداث: `src/lib/n8n-auth.ts`.
- نقاط النهاية الخاصة بالتذاكر: `src/app/api/webhooks/tickets`.
- نقطة استعلام البيانات: `src/app/api/webhooks/query/route.ts`.
- الملاحظات المحاسبية: `src/app/api/webhooks/accounting-notes/route.ts`.
- إدارة أرقام الواتساب: `src/app/dashboard/admin/pm-contacts/page.tsx`.

هذا الملف يعكس الوضع الحالي للمشروع، وأي تغييرات مستقبلية يجب تحديثها هنا لضمان الإحاطة الشاملة.
