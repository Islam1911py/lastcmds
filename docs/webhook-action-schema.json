{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Webhook API Action Schema",
  "description": "Role-separated catalog of webhook endpoints with JSON schema parameters.",
  "type": "object",
  "properties": {
    "roles": {
      "type": "array",
      "items": [
        {
          "role": "ADMIN",
          "description": "Endpoints reserved for admin API keys.",
          "endpoints": [
            {
              "url": "/api/webhooks/query",
              "method": "GET",
              "authentication": "X-API-KEY header tied to an ADMIN user",
              "queryTypes": [
                {
                  "name": "ALL_DATA",
                  "description": "Retrieve platform-wide statistics (projects, units, residents, tickets, invoices, staff).",
                  "parameters": {
                    "type": "object",
                    "properties": {
                      "type": { "type": "string", "enum": ["ALL_DATA", "DEFAULT"] },
                      "senderPhone": { "type": ["string", "null"], "pattern": "^\\+?[0-9]{8,15}$" }
                    },
                    "required": ["type"],
                    "additionalProperties": true
                  },
                  "notes": [
                    "If type is omitted the handler defaults to ALL_DATA for admin keys.",
                    "Response meta carries summary counts for leadership dashboards."
                  ]
                }
              ]
            }
          ]
        },
        {
          "role": "PROJECT_MANAGER",
          "description": "Actions and queries available to project manager API keys.",
          "endpoints": [
            {
              "url": "/api/webhooks/project-managers",
              "method": "POST",
              "authentication": "X-API-KEY header tied to a PROJECT_MANAGER user",
              "envelope": {
                "type": "object",
                "required": ["action", "senderPhone", "payload"],
                "additionalProperties": false,
                "properties": {
                  "action": { "type": "string" },
                  "senderPhone": { "type": "string", "pattern": "^\\+?[0-9]{8,15}$" },
                  "payload": { "type": "object" }
                }
              },
              "actions": [
                {
                  "name": "CREATE_OPERATIONAL_EXPENSE",
                  "description": "Submit an operational expense for accounting review.",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "projectId": { "type": "string" },
                      "unitCode": { "type": "string" },
                      "description": { "type": "string", "minLength": 1 },
                      "amount": {
                        "oneOf": [
                          { "type": "number", "exclusiveMinimum": 0 },
                          { "type": "string", "pattern": "^\\d+(?:\\.\\d+)?$" }
                        ]
                      },
                      "sourceType": { "type": "string", "enum": ["OFFICE_FUND", "PM_ADVANCE"] },
                      "pmAdvanceId": { "type": ["string", "null"] },
                      "recordedAt": { "type": ["string", "null"], "format": "date-time" }
                    },
                    "required": ["projectId", "unitCode", "description", "amount", "sourceType"],
                    "additionalProperties": false
                  },
                  "notes": [
                    "Managers must be assigned to the project or have global project visibility.",
                    "pmAdvanceId is mandatory when sourceType is PM_ADVANCE."
                  ]
                },
                {
                  "name": "GET_RESIDENT_PHONE",
                  "description": "Fetch phone details for a resident within a project unit.",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "projectId": { "type": "string" },
                      "unitCode": { "type": "string" },
                      "residentName": { "type": ["string", "null"] },
                      "limit": {
                        "oneOf": [
                          { "type": "integer", "minimum": 1, "maximum": 5 },
                          { "type": "string", "pattern": "^\\d+$" }
                        ]
                      }
                    },
                    "required": ["projectId", "unitCode"],
                    "additionalProperties": false
                  }
                },
                {
                  "name": "LIST_PROJECT_TICKETS",
                  "description": "List tickets for a project with optional status or unit filters.",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "projectId": { "type": "string" },
                      "unitCode": { "type": ["string", "null"] },
                      "statuses": {
                        "type": ["array", "null"],
                        "items": { "type": "string" }
                      },
                      "limit": {
                        "oneOf": [
                          { "type": "integer", "minimum": 1, "maximum": 50 },
                          { "type": "string", "pattern": "^\\d+$" }
                        ]
                      }
                    },
                    "required": ["projectId"],
                    "additionalProperties": false
                  }
                },
                {
                  "name": "LIST_PROJECT_UNITS",
                  "description": "Return operational units for the project with optional search and limit settings.",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "projectId": { "type": "string" },
                      "includeInactive": { "type": ["boolean", "null"] },
                      "limit": {
                        "oneOf": [
                          { "type": "integer", "minimum": 1, "maximum": 100 },
                          { "type": "string", "pattern": "^\\d+$" }
                        ]
                      },
                      "search": { "type": ["string", "null"] }
                    },
                    "required": ["projectId"],
                    "additionalProperties": false
                  }
                },
                {
                  "name": "LIST_UNIT_EXPENSES",
                  "description": "List unit expenses visible to the project manager.",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "projectId": { "type": "string" },
                      "unitCode": { "type": ["string", "null"] },
                      "limit": {
                        "oneOf": [
                          { "type": "integer", "minimum": 1, "maximum": 50 },
                          { "type": "string", "pattern": "^\\d+$" }
                        ]
                      },
                      "sourceTypes": {
                        "type": ["array", "null"],
                        "items": { "type": "string", "enum": ["TECHNICIAN_WORK", "STAFF_WORK", "ELECTRICITY", "OTHER"] }
                      },
                      "search": { "type": ["string", "null"] },
                      "fromDate": { "type": ["string", "null"], "pattern": "^\\d{4}-\\d{2}-\\d{2}$" },
                      "toDate": { "type": ["string", "null"], "pattern": "^\\d{4}-\\d{2}-\\d{2}$" }
                    },
                    "required": ["projectId"],
                    "additionalProperties": false
                  }
                },
                {
                  "name": "GET_LAST_ELECTRICITY_TOPUP",
                  "description": "Fetch the latest electricity top-up for a unit within the manager's project.",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "projectId": { "type": "string" },
                      "unitCode": { "type": ["string", "null"] }
                    },
                    "required": ["projectId"],
                    "additionalProperties": false
                  }
                }
              ]
            },
            {
              "url": "/api/webhooks/query",
              "method": "GET",
              "authentication": "X-API-KEY header tied to a PROJECT_MANAGER user",
              "queryTypes": [
                {
                  "name": "LAST_EXPENSE",
                  "description": "Retrieve recent accounting notes for the manager's project.",
                  "parameters": {
                    "type": "object",
                    "properties": {
                      "type": { "type": "string", "const": "LAST_EXPENSE" },
                      "projectId": { "type": "string" },
                      "range": { "type": ["string", "null"], "enum": ["TODAY", "WEEK", "MONTH", null] },
                      "date": { "type": ["string", "null"], "pattern": "^\\d{4}-\\d{2}-\\d{2}$" },
                      "unit": { "type": ["string", "null"] },
                      "senderPhone": { "type": ["string", "null"], "pattern": "^\\+?[0-9]{8,15}$" }
                    },
                    "required": ["type", "projectId"],
                    "additionalProperties": false
                  },
                  "notes": [
                    "Range overrides date if both are supplied.",
                    "Managers must pass their assigned projectId explicitly."
                  ]
                },
                {
                  "name": "PROJECT_DATA",
                  "description": "Project dashboard summary including residents, tickets, staff, and technicians.",
                  "parameters": {
                    "type": "object",
                    "properties": {
                      "type": { "type": "string", "enum": ["PROJECT_DATA", "DEFAULT"] },
                      "projectId": { "type": "string" },
                      "senderPhone": { "type": ["string", "null"], "pattern": "^\\+?[0-9]{8,15}$" }
                    },
                    "required": ["projectId"],
                    "additionalProperties": false
                  }
                },
                {
                  "name": "TICKET_BY_RESIDENT",
                  "description": "List tickets linked to a resident inside the project.",
                  "parameters": {
                    "type": "object",
                    "properties": {
                      "type": { "type": "string", "const": "TICKET_BY_RESIDENT" },
                      "projectId": { "type": "string" },
                      "resident": { "type": "string" },
                      "senderPhone": { "type": ["string", "null"], "pattern": "^\\+?[0-9]{8,15}$" }
                    },
                    "required": ["type", "projectId", "resident"],
                    "additionalProperties": false
                  }
                },
                {
                  "name": "TODAY_TICKETS",
                  "description": "Tickets created today for the manager's project.",
                  "parameters": {
                    "type": "object",
                    "properties": {
                      "type": { "type": "string", "const": "TODAY_TICKETS" },
                      "projectId": { "type": "string" },
                      "senderPhone": { "type": ["string", "null"], "pattern": "^\\+?[0-9]{8,15}$" }
                    },
                    "required": ["type", "projectId"],
                    "additionalProperties": false
                  }
                }
              ]
            }
          ]
        },
        {
          "role": "ACCOUNTANT",
          "description": "Accounting actions and queries (also available to admins when acting as accountants).",
          "endpoints": [
            {
              "url": "/api/webhooks/accountants",
              "method": "POST",
              "authentication": "X-API-KEY header tied to an ACCOUNTANT or ADMIN user",
              "envelope": {
                "type": "object",
                "required": ["action", "senderPhone", "payload"],
                "additionalProperties": false,
                "properties": {
                  "action": { "type": "string" },
                  "senderPhone": { "type": "string", "pattern": "^\\+?[0-9]{8,15}$" },
                  "payload": { "type": "object" }
                }
              },
              "actions": [
                {
                  "name": "CREATE_PM_ADVANCE",
                  "description": "Create a PM advance entry.",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "staffId": { "type": ["string", "null"] },
                      "staffQuery": { "type": ["string", "null"] },
                      "amount": {
                        "oneOf": [
                          { "type": "number", "exclusiveMinimum": 0 },
                          { "type": "string", "pattern": "^\\d+(?:\\.\\d+)?$" }
                        ]
                      },
                      "projectId": { "type": ["string", "null"] },
                      "notes": { "type": ["string", "null"] }
                    },
                    "required": ["amount"],
                    "anyOf": [ { "required": ["staffId"] }, { "required": ["staffQuery"] } ],
                    "additionalProperties": false
                  },
                  "notes": [
                    "Either staffId or staffQuery must be provided.",
                    "projectId is optional but validated when present."
                  ]
                },
                {
                  "name": "CREATE_STAFF_ADVANCE",
                  "description": "Create a staff advance in pending status.",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "staffId": { "type": ["string", "null"] },
                      "staffQuery": { "type": ["string", "null"] },
                      "amount": {
                        "oneOf": [
                          { "type": "number", "exclusiveMinimum": 0 },
                          { "type": "string", "pattern": "^\\d+(?:\\.\\d+)?$" }
                        ]
                      },
                      "note": { "type": ["string", "null"] }
                    },
                    "required": ["amount"],
                    "anyOf": [ { "required": ["staffId"] }, { "required": ["staffQuery"] } ],
                    "additionalProperties": false
                  }
                },
                {
                  "name": "UPDATE_STAFF_ADVANCE",
                  "description": "Update amount or note on an existing pending advance.",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "advanceId": { "type": "string" },
                      "amount": {
                        "oneOf": [
                          { "type": "number", "exclusiveMinimum": 0 },
                          { "type": "string", "pattern": "^\\d+(?:\\.\\d+)?$" }
                        ]
                      },
                      "note": { "type": ["string", "null"] },
                      "staffQuery": { "type": ["string", "null"] }
                    },
                    "required": ["advanceId"],
                    "anyOf": [ { "required": ["amount"] }, { "required": ["note"] } ],
                    "additionalProperties": false
                  }
                },
                {
                  "name": "DELETE_STAFF_ADVANCE",
                  "description": "Delete a pending staff advance entry.",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "advanceId": { "type": "string" },
                      "staffQuery": { "type": ["string", "null"] }
                    },
                    "required": ["advanceId"],
                    "additionalProperties": false
                  }
                },
                {
                  "name": "RECORD_ACCOUNTING_NOTE",
                  "description": "Convert a pending accounting note into an expense/invoice pair.",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "noteId": { "type": "string" },
                      "sourceType": { "type": ["string", "null"], "enum": ["OFFICE_FUND", "PM_ADVANCE", null] },
                      "pmAdvanceId": { "type": ["string", "null"] }
                    },
                    "required": ["noteId"],
                    "additionalProperties": false
                  }
                },
                {
                  "name": "PAY_INVOICE",
                  "description": "Record a payment toward an owner invoice.",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "invoiceId": { "type": "string" },
                      "amount": {
                        "oneOf": [
                          { "type": "number", "exclusiveMinimum": 0 },
                          { "type": ["string", "null"], "pattern": "^\\d+(?:\\.\\d+)?$" }
                        ]
                      },
                      "action": { "type": ["string", "null"], "enum": ["pay", "mark-paid", null] }
                    },
                    "required": ["invoiceId"],
                    "additionalProperties": false
                  }
                },
                {
                  "name": "CREATE_PAYROLL",
                  "description": "Generate payroll for the specified month.",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "month": { "type": "string", "pattern": "^\\d{4}-\\d{2}$" }
                    },
                    "required": ["month"],
                    "additionalProperties": false
                  }
                },
                {
                  "name": "PAY_PAYROLL",
                  "description": "Mark a payroll as paid and deduct pending advances.",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "payrollId": { "type": "string" }
                    },
                    "required": ["payrollId"],
                    "additionalProperties": false
                  }
                },
                {
                  "name": "LIST_UNIT_EXPENSES",
                  "description": "List unit expenses with optional filters (accountant view).",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "projectId": { "type": ["string", "null"] },
                      "unitCode": { "type": ["string", "null"] },
                      "limit": {
                        "oneOf": [
                          { "type": "integer", "minimum": 1, "maximum": 100 },
                          { "type": "string", "pattern": "^\\d+$" }
                        ]
                      },
                      "sourceTypes": {
                        "type": "array",
                        "items": { "type": "string", "enum": ["TECHNICIAN_WORK", "STAFF_WORK", "ELECTRICITY", "OTHER"] }
                      },
                      "search": { "type": ["string", "null"] },
                      "fromDate": { "type": ["string", "null"], "pattern": "^\\d{4}-\\d{2}-\\d{2}$" },
                      "toDate": { "type": ["string", "null"], "pattern": "^\\d{4}-\\d{2}-\\d{2}$" }
                    },
                    "additionalProperties": false
                  }
                },
                {
                  "name": "SEARCH_STAFF",
                  "description": "Fuzzy search for staff with optional pending-advance filter.",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "query": { "type": "string" },
                      "projectId": { "type": ["string", "null"] },
                      "limit": {
                        "oneOf": [
                          { "type": "integer", "minimum": 1, "maximum": 50 },
                          { "type": "string", "pattern": "^\\d+$" }
                        ]
                      },
                      "onlyWithPendingAdvances": { "type": ["boolean", "null"] }
                    },
                    "required": ["query"],
                    "additionalProperties": false
                  }
                },
                {
                  "name": "LIST_STAFF_ADVANCES",
                  "description": "List staff advances with optional status and name filters.",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "query": { "type": ["string", "null"] },
                      "status": { "type": ["string", "null"], "enum": ["PENDING", "DEDUCTED", "ALL", null] },
                      "projectId": { "type": ["string", "null"] },
                      "limit": {
                        "oneOf": [
                          { "type": "integer", "minimum": 1, "maximum": 200 },
                          { "type": "string", "pattern": "^\\d+$" }
                        ]
                      }
                    },
                    "additionalProperties": false
                  }
                },
                {
                  "name": "SEARCH_ACCOUNTING_NOTES",
                  "description": "Search accounting notes by text, status, or unit filters.",
                  "payloadSchema": {
                    "type": "object",
                    "properties": {
                      "query": { "type": ["string", "null"] },
                      "status": { "type": ["string", "null"], "enum": ["PENDING", "CONVERTED", "REJECTED", "ALL", null] },
                      "projectId": { "type": ["string", "null"] },
                      "unitCode": { "type": ["string", "null"] },
                      "limit": {
                        "oneOf": [
                          { "type": "integer", "minimum": 1, "maximum": 150 },
                          { "type": "string", "pattern": "^\\d+$" }
                        ]
                      },
                      "includeConverted": { "type": ["boolean", "null"] }
                    },
                    "additionalProperties": false
                  }
                }
              ]
            },
            {
              "url": "/api/webhooks/query",
              "method": "GET",
              "authentication": "X-API-KEY header tied to an ACCOUNTANT or ADMIN user",
              "queryTypes": [
                {
                  "name": "ACCOUNTING_DATA",
                  "description": "Finance snapshot with invoices, payments, and pending accounting notes.",
                  "parameters": {
                    "type": "object",
                    "properties": {
                      "type": { "type": "string", "enum": ["ACCOUNTING_DATA", "DEFAULT"] },
                      "senderPhone": { "type": ["string", "null"], "pattern": "^\\+?[0-9]{8,15}$" }
                    },
                    "required": ["type"],
                    "additionalProperties": true
                  },
                  "notes": [
                    "If type is omitted the handler defaults to ACCOUNTING_DATA for accountant keys.",
                    "Responses include statistics plus invoice and pending-note collections."
                  ]
                }
              ]
            }
          ]
        }
      ]
    },
    "shared": {
      "type": "object",
      "properties": {
        "endpoints": {
          "type": "array",
          "items": [
            {
              "url": "/api/webhooks/query/interpret",
              "method": "POST",
              "authentication": "X-API-KEY header tied to any managed role",
              "requestSchema": {
                "type": "object",
                "required": ["question"],
                "additionalProperties": false,
                "properties": {
                  "question": { "type": "string", "minLength": 1 },
                  "projectName": { "type": ["string", "null"] },
                  "role": { "type": ["string", "null"], "enum": ["ADMIN", "ACCOUNTANT", "PROJECT_MANAGER", null] }
                }
              },
              "notes": [
                "If role is omitted the interpreter relies on the API key context.",
                "projectName can disambiguate when the question does not mention the project explicitly."
              ]
            },
            {
              "url": "/api/webhooks/identity",
              "method": "POST",
              "authentication": "X-API-KEY header tied to any managed role",
              "requestSchema": {
                "type": "object",
                "properties": {
                  "phone": { "type": ["string", "null"], "pattern": "^\\+?[0-9]{8,15}$" },
                  "senderPhone": { "type": ["string", "null"], "pattern": "^\\+?[0-9]{8,15}$" },
                  "contact": { "type": ["string", "null"] },
                  "query": { "type": ["string", "null"] }
                },
                "anyOf": [
                  { "required": ["phone"] },
                  { "required": ["senderPhone"] },
                  { "required": ["contact"] },
                  { "required": ["query"] }
                ],
                "additionalProperties": false
              },
              "notes": [
                "At least one identifier must be provided.",
                "The resolver checks managed users first, then residents using phone variants."
              ]
            }
          ]
        }
      },
      "required": ["endpoints"]
    }
  },
  "required": ["roles", "shared"]
}
